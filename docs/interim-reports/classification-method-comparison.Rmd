---
title: "Testing species classifiers"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load_libraries}
library(sf)
library(tidyverse)
library(purrr)
library(raster)
library(tictoc)
library(here)
library(caret)
```

# Introduction

We want to classify tree species using our aerial imagery, so we will test a few different classifiers using data that has been hand-classified to a known species. That is, the crown segments for these trees have already been delineated, then we overlaid them on top of the ortho-index for the given plot, added the known ground trees (with their species ID) to the plot (all in QGIS), and marked crowns as their appropriate species.

We will implement a bunch of classification methods using the `caret` package, and pick one that performs well.

```{r read_data}
crowns_with_reflectance <- readr::read_csv(here::here("data/data_output/classified/hand-classified/hand-classified-crowns.csv"))
```

# First classify live verus dead

We first want to classify which trees are alive and which are dead. I've had success doing this with logistc regression in the past, so we will start there. To prepare to do this in `caret`, we partition the data into a training and a testing subset.

```{r partition_data_for_live_dead_classification}
live_or_dead_idx <- caret::createDataPartition(crowns_with_reflectance$live, p = 0.8, list = FALSE)

live_or_dead_training <- crowns_with_reflectance[live_or_dead_idx, ]
live_or_dead_testing <- crowns_with_reflectance[-live_or_dead_idx, ]
```

```{r implement_boosted_logistic_regression}
live_or_dead_fit <- train(
  as.factor(live) ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = live_or_dead_training,
  method = "LogitBoost"
)

live_or_dead_fit
```

That works pretty well!

# Data prep for species classification

Next, we subset our data to just the live crowns, so that we can classify species. We partition the data representing just the live crowns as we did for the data that included all the crowns.

```{r subset_to_live_crowns}
live_crowns <- 
  crowns_with_reflectance %>% 
  dplyr::filter(live == 1) %>% 
  dplyr::mutate(functional_group = case_when(species == "pila" ~ "pinus",
                                             species == "pipo" ~ "pinus",
                                             TRUE ~ species))


species_idx <-
  live_crowns %>%
  pull(species) %>% 
  caret::createDataPartition(p = 0.8, list = FALSE)

species_training <- live_crowns[species_idx, ]
species_testing <- live_crowns[-species_idx, ]
```

How many classified samples are there per species?

```{r species_sample_count}
live_crowns %>% 
  count(species)
```

In case it becomes useful later, we'll collapse PILA and PIPO into a single group "Pinus"

```{r functional_groups}
functional_group_idx <-
  live_crowns %>%
  pull(functional_group) %>% 
  caret::createDataPartition(p = 0.8, list = FALSE)

functional_group_training <- live_crowns[functional_group_idx, ]
functional_group_testing <- live_crowns[-functional_group_idx, ]
```

# Different classification approaches

```{r regularized_discriminant_analysis}
# regularized discriminant analysis (rda) --------------------------------------
# accuracy: 70%
# kappa: 0.606
rdaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "rda",
  preProcess = c("center", "scale"),
  tuneGrid = expand.grid(gamma = 0, lambda = c(seq(0.2, 1.0, by = 0.1)))
)

rdaFit

rdaProbs <- predict(rdaFit, newdata = species_testing, type = "prob")
head(rdaProbs)
species_testing
```

```{r penalized_discriminat_analysis}
# penalized discriminant analysis (pda) --------------------------------------
# accuracy: 67%
# kappa: 0.566
pdaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "pda",
  preProcess = c("center", "scale"),
  tuneGrid = expand.grid(lambda = seq(0.15, 0.25, by = 0.01))
)

pdaFit

pdaProbs <- predict(pdaFit, newdata = species_testing, type = "prob")
head(rdaProbs)
species_testing
```


```{r localized_linear_discriminant_analysis}
# localized linear discriminant analysis (loclda) --------------------------------------
# accuracy: 67%
# kappa: 0.55
locldaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "loclda",
  preProcess = c("center", "scale")
)

locldaFit

locldaProbs <- predict(locldaFit, newdata = species_testing, type = "prob")
head(locldaProbs)
species_testing
```

```{r penalized_discriminanat_analysis_pda2}
# penalized discriminant analysis (pda2) --------------------------------------
# accuracy: 66%
# kappa: 0.54
pda2Fit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "pda2",
  preProcess = c("center", "scale"),
  tuneGrid = expand.grid(df = 4:9)
)

pda2Fit

pda2Probs <- predict(pda2Fit, newdata = species_testing, type = "prob")
head(pda2Probs)
species_testing
```

```{r linear_discriminant_analysis_lda}
# linear discriminant analysis (lda) --------------------------------------
# accuracy: 65%
# kappa: 0.53
ldaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "lda",
  preProcess = c("center", "scale")
)

ldaFit

ldaProbs <- predict(ldaFit, newdata = species_testing, type = "prob")
head(ldaProbs)
species_testing
```

```{r mixture_discriminant_analysis}
# mixture discriminant analysis (mda) --------------------------------------
# accuracy: 65.4%
# kappa: 0.537
mdaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "mda",
  preProcess = c("center", "scale"),
  tuneGrid = expand.grid(subclasses = 1:3)
)

mdaFit

mdaProbs <- predict(mdaFit, newdata = species_testing, type = "prob")
head(mdaProbs)
species_testing
```

```{r linear_discriminant_analysis_lda2}
# linear discriminant analysis (lda2) -------------------------------------
# accuracy: 64%
# kappa: 0.52

tuneGrid <- expand.grid(dimen = c(3:6))

lda2Fit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "lda2",
  preProcess = c("center", "scale"),
  tuneGrid = tuneGrid
)

lda2Fit

lda2Probs <- predict(ldaFit, newdata = species_testing, type = "prob")
head(lda2Probs)
species_testing
```

```{r simple_random_forest}
# simple random forest ----------------------------------------------------
# accuracy: 57%
# kappa: 0.41
rfFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "rf",
  preProcess = c("center", "scale")
)

rfFit

rfProbs <- predict(rfFit, newdata = species_testing, type = "prob")
head(rfProbs)
species_testing
```

```{r conditional_inference_random_forest}
# conditional inference random forest -------------------------------------
# accuracy: 54%
# kappa: 0.37

cforestFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "cforest",
  preProcess = c("center", "scale")
)

cforestFit
cforestProbs <- predict(cforestFit, newdata = species_testing, type = "prob")
head(cforestProbs)
species_testing
```



```{r boosted_trees}
# boosted trees (bstTree) --------------------------------------
# accuracy: 31%
# kappa: 0.308

bstTreeFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "bstTree",
  preProcess = c("center", "scale")
)

bstTreeFit
```

```{r heteroscedastic_discriminant_analysis}
# heteroscedastic discriminant analysis (hda) --------------------------------------
# accuracy: 55%
# kappa: 0.40
hdaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "hda",
  preProcess = c("center", "scale")
)

hdaFit
```

```{r high_dimensional_discriminant_analysis}
# high-dimensional discriminant analysis (hdda) --------------------------------------
# accuracy: 63%
# kappa: 0.51
hddaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "hdda",
  preProcess = c("center", "scale")
)

hddaFit
```

```{r linear_discriminant_analysis_with_stepwise_feature_selection}
# linear discriminant analysis with stepwise feature selection (stepLDA) --------------------------------------
# accuracy: 45%
# kappa: 0.26
stepLDAFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "stepLDA",
  preProcess = c("center", "scale")
)

stepLDAFit
```

```{r maximum_uncertainty_linear_discriminant_analysis}
# maximum uncertainty linear discriminant analysis (Mlda) --------------------------------------
# accuracy: 50%
# kappa: 0.31
MldaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "Mlda",
  preProcess = c("center", "scale")
)

MldaFit
```

```{r quadratic_discriminant_analysis}
# quadratic discriminant analysis (qda) --------------------------------------
# accuracy: 56%
# kappa: 0.39
qdaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "qda",
  preProcess = c("center", "scale")
)

qdaFit
```

```{r robust_linear_discriminant_analysis}
# robust linear discriminant analysis (Linda) --------------------------------------
# accuracy: 53%
# kappa: 0.38
LindaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "Linda",
  preProcess = c("center", "scale")
)

LindaFit
```

```{r robust_regularized_linear_discriminant_analysis}
# robust regularized linear discriminant analysis (rrlda) --------------------------------------
# accuracy: 52%
# kappa: 0.40
rrldaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "rrlda",
  preProcess = c("center", "scale")
)

rrldaFit
```


```{r shrinkage_linear_discriminant_analysis}
# shrinkage linear discriminant analysis (sda) --------------------------------------
# accuracy: 63%
# kappa: 0.51
sdaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "sda",
  preProcess = c("center", "scale"),
  tuneGrid = expand.grid(lambda = c(0.0, 0.5, 1.0), diagonal = c(TRUE, FALSE))
)

sdaFit
```


```{r sparse_linear_discriminant_analysis}
# sparse linear discriminant analysis (sparseLDA) --------------------------------------
# accuracy: 63%
# kappa: 0.51
sparseLDAFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "sparseLDA",
  preProcess = c("center", "scale")
  )

sparseLDAFit

sparseLDAProbs <- predict(sparseLDAFit, newdata = species_testing, type = "prob")
head(sparseLDAProbs)
species_testing
```

```{r stabilized_linear_discriminant_analysis}
# sparse linear discriminant analysis (slda) --------------------------------------
# accuracy: 41%
# kappa: 0.51
sldaFit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = species_training,
  method = "slda",
  preProcess = c("center", "scale")
  )

sldaFit

sldaProbs <- predict(sldaFit, newdata = species_testing, type = "prob")
head(sldaProbs)
species_testing

slda <- data_frame(method = "slda", 
                   accuracy = sldaFit$results$Accuracy, 
                   kappa = sldaFit$results$Kappa)
```

# Summary table of methods

```{r summary_table}
all_methods <- c("rda", "pda", "loclda", "pda2", "lda", "mda", "lda2", "rf", "cforest", "bstTree", "hda", "hdda", "stepLDA", "Mlda", "qda", "Linda", "rrlda", "sda", "slda", "sparseLDA")
all_fits <- paste0(all_methods, "Fit")
all_accuracy <- purrr::map_dbl(all_fits, .f = function(fit) {max(get(fit)$results$Accuracy)})
all_kappa <- purrr::map_dbl(all_fits, .f = function(fit) {max(get(fit)$results$Kappa)})

results <- data_frame(method = all_methods, accuracy = all_accuracy, kappa = all_kappa) %>% 
  arrange(desc(accuracy))
```

```{r print_results, results = "asis"}
library(knitr)
kable(results, caption = "Summary of classification methods arranged in descending order of accuracy.")

```

## Some packages removed from CRAN

These packages were removed from CRAN, which means the methods available in `caret` don't work.

- sparsediscrim (for rlda, dda, hdrda method)
- adaptDA (for amdai method)

# Using spectral libraries

We may also be able to take advantage of pre-existing spectral libraries to train a classifier. If a previous effort to measure reflectance on known tree species exists, then we can use those values if they match up to the reflectance sensitivity on my instrument.

## Information about my instrument
I used the MicaSense RedEdge3 and calibrated the imagery each flight to a reflectance panel with known reflectance values for the 5 narrow bands of the RedEdge instrument.

The manual with more information can be found here: http://www.leptron.com/manuals/RedEdge_User_Manual.pdf

```{r rededge}
micasense_rededge <-
  data_frame(band = 1:5,
             band_name = c("b", "g", "r", "nir", "re"),
             center_wavelength = c(475, 560, 668, 840, 717),
             bandwidth = c(20, 20, 10, 40, 10)) %>%
  dplyr::mutate(start_wavelength = center_wavelength - (bandwidth / 2),
                end_wavelength = center_wavelength + (bandwidth / 2))

species_present <- c("abco", "cade", "pipo", "pila", "quke")
```

## Some pre-existing libraries

### Serbin
NASA HyspIRI Airborne Campaign Leaf and Canopy Spectra and Leaf Traits
https://ecosis.org/#result/dd94f09c-1794-44f4-82e9-a7ca707a1ec0
The file is called: data/data_raw/nasa-hyspiri-airborne-campaign-leaf-and-canopy-spectra-and-leaf-traits

This dataset includes all the species that I want to classify, but it seems to not do a great job of matching up to the measurements that I took with the Micasense RedEdge

```{r serbin}
serbin <- read_csv(here::here("data/data_raw/nasa-hyspiri-airborne-campaign-leaf-and-canopy-spectra-and-leaf-traits.csv")) %>%
  dplyr::select(`Latin Genus`, `Latin Species`, Leaf_or_Canopy, Sample_Name, 21:ncol(.)) %>%
  dplyr::filter(Leaf_or_Canopy == "leaf") %>%
  dplyr::mutate(genus = substr(`Latin Genus`, start = 1, stop = 2), species = substr(`Latin Species`, start = 1, stop = 2)) %>%
  dplyr::mutate(species = tolower(paste0(genus, species))) %>%
  dplyr::select(-`Latin Genus`, -`Latin Species`, -Leaf_or_Canopy) %>%
  dplyr::rename(replicate = Sample_Name) %>%
  dplyr::select(species, replicate, everything()) %>%
  dplyr::mutate(replicate = paste("serbin", species, replicate, sep = "_")) %>%
  dplyr::filter(species %in% species_present) %>%
  tidyr::gather(key = "wavelength", value = "reflectance", -(1:2)) %>%
  dplyr::mutate(wavelength = as.numeric(wavelength)) %>%
  dplyr::mutate(reflectance = as.numeric(reflectance)) %>%
  dplyr::mutate(band_name = case_when(  (wavelength >= micasense_rededge$start_wavelength[1] & wavelength <= micasense_rededge$end_wavelength[1]) ~ "b",
                                        (wavelength >= micasense_rededge$start_wavelength[2] & wavelength <= micasense_rededge$end_wavelength[2]) ~ "g",
                                        (wavelength >= micasense_rededge$start_wavelength[3] & wavelength <= micasense_rededge$end_wavelength[3]) ~ "r",
                                        (wavelength >= micasense_rededge$start_wavelength[4] & wavelength <= micasense_rededge$end_wavelength[4]) ~ "nir",
                                        (wavelength >= micasense_rededge$start_wavelength[5] & wavelength <= micasense_rededge$end_wavelength[5]) ~ "re")) %>%
  dplyr::filter(!is.na(band_name)) %>%
  dplyr::group_by(species, replicate, band_name) %>%
  dplyr::summarize(reflectance = mean(reflectance)) %>%
  dplyr::mutate(source = "serbin")
```

### Susan Meerdink
https://www.sciencedirect.com/science/article/pii/S0034425716303066?via%3Dihub
https://ecosis.org/#result/0fadcc45-f79e-4fd3-a6ca-8afaf26ae299
The file is called data/data_raw/fresh-leaf-spectra-to-estimate-leaf-traits-for-california-ecosystems.csv

This dataset does include almost all of the species I want to classify, but seems to do a pretty bad job matching up to the reflectance values that I captured.


```{r meerdink}
meerdink <- read_csv(here::here("data/data_raw/fresh-leaf-spectra-to-estimate-leaf-traits-for-california-ecosystems.csv")) %>%
  dplyr::mutate(species = tolower(species)) %>%
  dplyr::mutate(age = ifelse(str_detect(`sample name`, pattern = "Old"), yes = "old", no = "young")) %>%
  dplyr::filter(age == "young") %>%
  dplyr::mutate(replicate = paste("meerdink", species, Replicate, sep = "_")) %>%
  dplyr::filter(species %in% species_present) %>%
  dplyr::select(species, replicate, 35:ncol(.)) %>%
  tidyr::gather(key = "wavelength", value = "reflectance", -(1:2)) %>%
  dplyr::mutate(wavelength = as.numeric(wavelength)) %>%
  dplyr::mutate(band_name = case_when(  (wavelength >= micasense_rededge$start_wavelength[1] & wavelength <= micasense_rededge$end_wavelength[1]) ~ "b",
                                        (wavelength >= micasense_rededge$start_wavelength[2] & wavelength <= micasense_rededge$end_wavelength[2]) ~ "g",
                                        (wavelength >= micasense_rededge$start_wavelength[3] & wavelength <= micasense_rededge$end_wavelength[3]) ~ "r",
                                        (wavelength >= micasense_rededge$start_wavelength[4] & wavelength <= micasense_rededge$end_wavelength[4]) ~ "nir",
                                        (wavelength >= micasense_rededge$start_wavelength[5] & wavelength <= micasense_rededge$end_wavelength[5]) ~ "re")) %>%
  dplyr::filter(!is.na(band_name)) %>%
  dplyr::group_by(species, replicate, band_name) %>%
  dplyr::summarize(reflectance = mean(reflectance)) %>%
  dplyr::mutate(source = "meerdink")
```  


### Natalie Queally
https://ecosis.org/#result/c1a5b651-9c46-4e06-a07f-38a2e7b4faf4
The file is called: data/data_raw/california_species_data.csv

This dataset seems to best align with my imagery, perhaps because it was a field-based instrument capturing canopy reflectance instead of a lab-based instrument capturing cut leaf reflectance. Unfortunately, not all of the key species I need to classify are represented.


```{r queally}
queally <- read_csv(here::here("data/data_raw/california_species_data.csv")) %>%
  dplyr::mutate(species = USDA_symbol) %>%
  dplyr::filter(species %in% species_present) %>%
  dplyr::mutate(replicate = paste("queally", species, 1:nrow(.), sep = "_")) %>%
  dplyr::select(species, replicate, 23:ncol(.)) %>%
  tidyr::gather(key = "wavelength", value = "reflectance", -(1:2)) %>%
  dplyr::mutate(wavelength = as.numeric(wavelength)) %>%
  dplyr::mutate(band_name = case_when(  (wavelength >= micasense_rededge$start_wavelength[1] & wavelength <= micasense_rededge$end_wavelength[1]) ~ "b",
                                        (wavelength >= micasense_rededge$start_wavelength[2] & wavelength <= micasense_rededge$end_wavelength[2]) ~ "g",
                                        (wavelength >= micasense_rededge$start_wavelength[3] & wavelength <= micasense_rededge$end_wavelength[3]) ~ "r",
                                        (wavelength >= micasense_rededge$start_wavelength[4] & wavelength <= micasense_rededge$end_wavelength[4]) ~ "nir",
                                        (wavelength >= micasense_rededge$start_wavelength[5] & wavelength <= micasense_rededge$end_wavelength[5]) ~ "re")) %>%
  dplyr::filter(!is.na(band_name)) %>%
  dplyr::group_by(species, replicate, band_name) %>%
  dplyr::summarize(reflectance = mean(reflectance)) %>%
  dplyr::mutate(source = "queally")
```

```{r construct_full_library}
spectral_library <-
  rbind(serbin, queally, meerdink)

spectral_library <-
  spectral_library %>%
  spread(key = band_name, value = reflectance) %>%
  ungroup()

colnames(spectral_library)[4:8] <- paste(colnames(spectral_library)[4:8], "mean", sep = "_")

spectral_library <-
  spectral_library %>%
  dplyr::mutate(ndvi_mean = (nir_mean - r_mean) / (nir_mean + r_mean),
                rgi_mean = r_mean / g_mean,
                gbi_mean = g_mean / b_mean,
                ndre_mean = (re_mean - r_mean) / (re_mean + r_mean))
```

Hmm... I'm not hopeful about this approach.
```{r train_on_spectral_library}
ldaFit_library <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = spectral_library,
  method = "lda"
)

ldaFit_library

lda_library_Probs <- predict(ldaFit_library, newdata = species_testing, type = "prob")
test <-
  species_testing %>%
  dplyr::mutate(predicted_species = predict(ldaFit_library, newdata = species_testing)) %>%
  dplyr::select(species, predicted_species)
head(test, 20)

# regularized discriminant analysis (rda) --------------------------------------
# accuracy: 70%
# kappa: 0.606
rda_library_Fit <- train(
  species ~ b_mean + g_mean + r_mean + re_mean + nir_mean + ndvi_mean + rgi_mean + gbi_mean + ndre_mean,
  data = spectral_library,
  method = "rda",
  preProcess = c("center", "scale"),
  tuneGrid = expand.grid(gamma = 0, lambda = c(seq(0.2, 1.0, by = 0.1)))
)

rda_library_Fit

rda_library_Probs <- predict(rda_library_Fit, newdata = species_testing, type = "prob")
head(rda_library_Probs)
species_testing
```

