---
bibliography: ../docs_carpentry/local-structure-wpb-severity.bib
csl: ../docs_carpentry/ecological-applications.csl
params:
  title: Local host tree density increases forest insect disturbance severity, but host size effect depends on climatic water deficit
  author: |
    Michael J. Koontz^1,2,\*^,
    Andrew M. Latimer^1,2^,
    Leif A. Mortenson^3^,
    Christopher J. Fettig^3^,
    Malcolm P. North^1,2,4^
  affiliation: |
    ^1^Graduate Group in Ecology, University of California, Davis, CA, USA  
    ^2^Department of Plant Sciences, University of California, Davis, CA, USA  
    ^3^USDA Forest Service, Pacific Southwest Research Station, Placerville, CA, USA  
    ^4^USDA Forest Service, Pacific Southwest Research Station, Davis, CA, USA
  correspondence: |
    michael.koontz@colorado.edu
  date_generated: !r format(Sys.Date(), "%B %d, %Y")
geometry: margin=1in
header-includes:
  - \usepackage[left]{lineno}
  - \linenumbers
  - \usepackage{setspace}
  - \doublespacing
  - \DeclareUnicodeCharacter{200E}{}
output: pdf_document
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

```{r libraries}
library(tidyverse)
# library(kableExtra)
library(pander)
```

```{r source_necessary_scripts}
source(here::here("analyses/evaluate-ground-correspondence-ttops.R"))
# Object to get information about extent of algorithm/paramter set coverage
# is called `algorithm_summary`
source(here::here("data/data_carpentry/format-ground-data.R"))
# Object with ground data is called `d`
```

```{r ground_data_deets}
pipo_pct_of_all_dead <-
  d %>%
  dplyr::filter(is.na(year_fall), !is.na(year_dead)) %>%
  group_by(species) %>%
  summarize(n = n(),
            prop_of_all_dead = n() / nrow(.),
            print_prop = round(prop_of_all_dead * 100, digits = 2)) %>%
  dplyr::filter(species == "PIPO") %>%
  pull(print_prop)

cade_pct_of_all_dead <-
  d %>%
  dplyr::filter(is.na(year_fall), !is.na(year_dead)) %>%
  group_by(species) %>%
  summarize(n = n(),
            prop_of_all_dead = n() / nrow(.),
            print_prop = round(prop_of_all_dead * 100, digits = 2)) %>%
  dplyr::filter(species == "CADE") %>%
  pull(print_prop)
```

```{r ground_tree_summary}
ground_tree_summary <- readr::read_csv(here::here("analyses/analyses_output/ground-tree-summary.csv"))

ground_tree_summary_print <-
  ground_tree_summary %>% 
  summarize(mean_total_count = mean(total_tree_count),
            mean_short_count = mean(tree_count_below_15m),
            mean_tall_count = mean(tree_count_above_15m),
            mean_nn1 = mean(nn_1_mean),
            mean_nn2 = mean(nn_2_mean),
            mean_nn3 = mean(nn_3_mean),
            mean_short_height = mean(height_lwr_25),
            mean_height = mean(height_mean),
            mean_tall_height = mean(height_upr_25))

```


```{r classifier_stats}
classifier_stats <- read_csv(here::here("analyses/analyses_output/classification-summary-stats.csv"))
```

```{r hand_classified_crowns}
hand_classified_crowns <- read_csv(here::here("data/data_output/classified/hand-classified/hand-classified-crowns.csv")) %>% 
  dplyr::mutate(site = substr(treeID, start = 1, stop = 9))
```

```{r feet_to_meters}
# 3000 = 914.4
# 4000 = 1219.2
# 5000 = 1524
# 6000 = 1828
# 7000 = 2133.6
```

#`r params$title`

`r params$author`

`r params$affiliation`

^\*^Correspondence: ``r params$correspondence``

Date report generated: `r params$date_generated`

## Executive Summary (to eventually become abstract)

Framing: environmental drivers of insect severity, forest structure drivers of insect severity, but *complex* forest structure is key as is relevant scale of local ecological process; little information on how the complex forest structure interacts with environmental drivers because these data are challenging to capture simultaneously...

Bark beetles are a primary mortality agent of trees in western U.S. forests, and the recent Californian hot drought of 2012 to 2015 created favorable conditions for bark beetle-induced tree mortality throughout the yellow pine/mixed-conifer forest system in the Sierra Nevada mountain range. The western pine beetle, *Dendroctonus brevicomis*, is the forest insect that is largely responsible for the especially common deaths of its main host in California, the ponderosa pine tree (*Pinus ponderosa*). While previous work has demonstrated a link between climate conditions related to tree water stress and forest density on the severity of the western pine beetle disturbance, it remains challenging to disentangle the relative effects of these variables. Further, forest density can affect western pine beetle behavior in a number of ways, which creates a need for more information on complex forest structure (including local density, tree size, and the heterogeneity of these variables across a forest stand) to uncover the most likely mechanism.

We conducted aerial surveys over an established network of 32 permanent vegetation monitoring plots along a 350km and 1000m elevation gradient in the Sierra Nevada mountain range of California using a small, unhumanned aerial system (sUAS aka drone) equipped with a narrow-band multispectral camera. Using Structure from Motion (SfM) processing on over 450,000 images, we reconstructed the complex vegetation structure of over 9 square kilometers of forest that experienced ponderosa pine mortality as a result of western pine beetle activity. Using this dataset, we built a model to predict the probability of ponderosa pine mortality as a function of forest structure variables (including ponderosa pine density and mean size, as well as all tree density and mean size), an environmental gradient of climatic water deficit, and a Gaussian process to capture spatial covariance in the response.

Data from small, unhummaned aerial systems (sUAS) can provide important context surrounding ground plots, which enables inference and generates new insights into ecological processes.
sUAS are best-suited to enhancing ground data, which implies that we need not abandon lessons learned from sound experimental design (i.e., a network of plots along a gradient is still a powerful way to use sUAS as an ecological tool).

Host availability for aggressive bark beetles appears to have played the dominant role in increasing the probability of ponderosa pine mortality in the most hard-hit forest stands during the cumulative mortality event of 2012 to 2018. Host size played a role in its interaction with environmental condition-- climatic water deficit-- such that numerous and smaller host trees increased the probability of ponderosa mortality at cool/wet sites, while numerous and larger host trees increased the probability of ponderosa mortality at hot/dry sites.

Our results corroborate the role of host tree density and regional climate conditions on the severity of forest insect disturbance, but also highlight the importance of complex forest structure (i.e., both host density and average host size) in its interaction with regional climate. Thus, the future forest structure may be affected differently by a large-scale forest insect disturbance for the same host tree/forest insect pairing, and during the same extreme drought, but across a gradient of regional climate conditions.

## Introduction

Aggressive bark beetles dealt the final blow to many of the nearly 150 million trees killed in the California drought of 2012 to 2015 and its aftermath [@usdafs2019]. A harbinger of climate change effects to come, record high temperatures exacerbating the drought [@griffin2014] increased water stress on trees, which increases their susceptibility to attacking bark beetles [@fettig2012b; @kolb2016]. A century of fire suppression policy has enabled forests to grow into dense stands, which also makes them more vulnerable to bark beetle attack [@fettig2012b; @north2015]. This combination of environmental conditions and forest structural characteristics led to tree mortality events of unprecedented size in the driest, densest forests across the state [@young2017]. The mechanisms underlying the link between tree susceptibility to insect attack and hot, dry conditions are often directly attributed to tree physiology [@bentz2010], but the link to forest density is multifaceted [@fettig2012b]. Because forest density is a coarse metric of the complex forest structure to which bark beetles respond [@raffa2008], our understanding of the connection between forest density and insect disturbance severity may be enhanced with more finely-resolved measures of forest structure [@stephenson2019]. Further, the interaction between local-scale complex forest structure and broad-scale environmental conditions as they affect forest insect disturbance remains underexplored [@seidl2016a].

The yellow pine/mixed-conifier forests in Californiaâ€™s Sierra Nevada region are characterized by regular bark beetle disturbances, primarily by the western pine beetle (*Dentrodctonus brevicomis*) and its main host in the system, ponderosa pine (*Pinus ponderosa*) [@fettig2019]. The western pine beetle is a "primary" or "aggressive" bark beetle, with reproductive success contingent upon host tree mortality [@raffa1983; @fettig2019]. This strong Allee effect creates a dynamic between beetle host selection behavior and host tree susceptibility to attack [@raffa1983; @logan1998]. Under normal conditions, primary bark beetles like the western pine beetle will sporadically kill weakened trees, but under outbreak conditions, wide swaths of even healthy trees may be killed [@bentz2010; @raffa2015]. A key defense mechanism of trees to bark beetle attack is to flood beetle bore holes with resin, which physically expels beetles and may interrupt beetle communication [@raffa2015]. Under severe water stress, trees may no longer have the resources available to mount this defense [@kolb2016] and thus prolonged drought can often trigger increased bark beetle-induced tree mortality as average tree vigor declines [@bentz2010].

Forest structure-- the spatial distribution, size, and species composition of trees-- also strongly influences western pine beetle activity. For instance, high-density forests are more prone to bark beetle attacks, and several mechanism likely underlie this phenomenon [@fettig2012b]. A high-density forest may experience greater bark beetle-induced tree mortality because host availability is high and shorter dispersal distances facilitate successful colonization of those hosts [@miller1960; @berryman1982; @fettig2007], because high host availability reduces the chance of landing on a non-host and imposing an energy cost to individual beetles [@moeck1981; @evenden2014], because crowded trees experience greater competition for water resources and thus average tree resistance is lower [@hayes2009], or because smaller gaps between trees protect pheromone plumes from dissipation by the wind and thus enhance intraspecific beetle communication [@thistle2004]. Additionally, tree size affects bark beetle host selection behavior as smaller trees tend to have less capacity for resisting attack, but larger trees represent a more desireable target because their thicker phloem provides greater nutritional value [@chubaty2009; @graf2012]. Tree density thus paints a fundamentally limited picture of the mechanism by which forest structure affects bark beetle disturbance, but *complex* forest structure-- with explicit recognition of tree size, species composition (e.g., host versus non-host composition), and variability in local tree density-- should more appropriately capture the ecological processes underlying insect-induced tree mortality. Additionally, considering the effects of complex forest structure simultaneously to the effects of environmental conditions may help refine our understanding of observed patterns of tree mortality in the recent California hot drought.

The vast spatial extent of tree mortality in the 2012 to 2015 California hot drought [@usdafs2019] challenges our ability to simultaneously consider how broad-scale environmental conditions may interact with local, complex forest structure to affect the dynamic between bark beetle host selection and host tree susceptibility to attack [@stephenson2019]. Measuring complex forest structure generally requires expensive equipment or labor-intensive field surveys [@larson2012; @kane2014; @asner2016], which constrains survey extent and frequency. Small, unhumanned aerial systems (sUAS) enable relatively fast and cheap remote imaging over dozens of hectares of forest, which can be used to determine both forest structure and tree condition at the individual tree scale [@morris2017; @shiklomanov2019]. Distributing such surveys across an environmental gradient is a viable approach to overcoming the data acquisition challenge inherent in investigating multi-scale phenomonena.

We used ultra-high resolution remote sensing data from a small, unhumanned aerial system over a network of 32 sites in the Sierra Nevada spanning 1000m of elevation and 350km of latitude and covering a total of 9 square kilometers of forest to ask how broad-scale environmental conditions interacted with local, complex forest structure to affect the probability of tree mortality during the cumulative mortality event of 2012 to 2018. We asked:

1. How does local host tree density and size affect the severity of western pine beetle disturbance? 

2. How does total tree density and size affect the severity of western pine beetle disturbance?

3. How does environmentally-driven tree moisture stress affect the severity of western pine beetle disturbance?

4. Do the effects of forest structure and environmental condition on western pine beetle disturbance interact?

## Methods

```{r, results = "hide", eval = FALSE, echo = FALSE}
fig_nums(name = "fig-")
```

### Study system

The study sites comprise mostly ponderosa pine trees, *Pinus ponderosa*, whose primary bark beetle predator in California is the western pine beetle (WPB), *Dendroctonus brevicomis*. The WPB is an aggressive bark beetle, meaning it must attack and kill live trees in order to successfully reproduce [@raffa2008]. Pioneer WPBs disperse to a new host tree, determine the host's susceptibility to attack, and use pheromone signals to attract other WPBs. The attracted WPBs mass attack the tree by boring into its inner bark, laying eggs, and dying, leaving their offspring to develop inside the doomed tree before themselves dispersing [@raffa2008]. Small WPB populations prefer weakened trees but large populations can overwhelm the defense mechanisms of even healthy trees. Successful attacks on large, healthy trees are boons to bark beetle fecundity and trigger outbreaks in which populations explode and massive tree mortality occurs. In California, the WPB can have 3 generations in a single year giving it a greater potential to spread rapidly through forests than its more infamous congener, the mountain pine beetle, *Dendroctonus ponderosa* (MPB).

We built our study on 180 vegetation/forest insect monitoring plots at 36 sites established between 2016 and 2017 [@fettig2019]. These established plots were located in beetle-attacked, mixed-conifer forests across the Eldorado, Stanislaus, Sierra and Sequoia National Forests and were stratified by elevation (914-1219 meters [3000-4000 feet], 1219-1524 meters [4000-5000 feet], 1524-1828 meters [5000-6000 feet] above sea level). In the Sequoia National Forest, the National Forest that is furthest south, plots were stratified with the lowest elevation band between 1219 and 1524 (4000-5000 feet) and extended to an upper elevation band of 1828-2133 (6000-7000 feet) to capture a more similar forest community composition as at the more northern National Forests. The sites have variable forest structure and disturbance history and plot locations were selected specifically in areas with >40% ponderosa pine basal area and >10% ponderosa pine mortality. The 0.04ha circular plots are clustered along transects in groups of 5, with between 80 and 200m between each plot. All trees within the plot were assessed as dead or alive. The stem location of all trees was mapped relative to the center of each plot using azimuth/distance measurements. Tree identity to species and diameter at breast height (dbh) were recorded if dbh was greater than 6.35cm. During the spring and early summer of 2018, all field plots were revisited to assess whether dead trees had fallen [@fettig2019].

![The network of field plots spanned a 350 km latitudinal gradient from the Eldorado National Forest in the north to the Sequoia National Forest in the south. Plots were stratified by three elevation bands in each forest, with the plots in the Sequoia National Forest (the southern-most National Forest) occupying elevation bands 305m above the three bands in the other National Forests in order to capture a similar community composition.](../../figures/study-geographic-extent-inset.png){ height=7in }

### Instrumentation

Imagery was captured using a DJI Zenmuse X3 RGB camera [@dji2015] and a Micasense RedEdge3 5-band multispectral camera [@micasense2015]. We mounted both of these instruments simultaneously on a DJI Matrice 100 aircraft [@dji2015a] using the DJI 3-axis stabilized gimbal for the Zenmuse X3 camera and a Micasense angled fixed mount for the RedEdge3 camera. The gimbal and the angled fixed mount ensured both instruments were nadir-facing during image capture. Just prior or after image capture at each site, we calibrated the RedEdge3 camera by taking an image of a calibration panel on the ground in full sun with known reflectance values for each of the 5 narrow bands.

```{r rededge_deets, echo = FALSE, include = TRUE, results = 'asis'}
rededge_print <- 
  tibble(`Band\nnumber` = 1:5,
         `Band\nname` = c("blue (b)", "green (g)", "red (r)", "near infrared (nir)", "red edge (re)"),
         `Center\nwavelength` = c(475, 560, 668, 840, 717),
         `Band\nwidth` = c(20, 20, 10, 40, 10),
         `Wavelength\nrange` = c("465-485", "550-570", "663-673", "820-860", "712-722"),
         `Panel\nreflectance` = c(0.64, 0.64, 0.64, 0.60, 0.63))

pandoc.table(rededge_print, 
             split.tables = Inf,
             caption = "Reflectance sensitivity of the Micasense Rededge3 camera. The calibration panel value represents the reflectance of the calibration panel for the given wavelength.",
             keep.line.breaks = TRUE)
```

### Flight protocol

Image capture was conducted as close to solar noon as possible to minimize shadow effects (always within 4 hours; usually within 2 hours). Prior to the aerial survey, two strips of bright orange drop cloth (~100cm x 15cm) were positioned as an "X" over the permanent monuments marking the center of the 5 field plots from @fettig2019.

For each of the 36 sites (containing 5 plots each), we captured imagery over the surrounding ~40 hectares of forested area using north-south aerial transects. For three sites, we surveyed less surrounding area in order to maintain visual and radio communication with the aircraft during flight which can be obstructed by steep terrain or non-centrally available takeoff locations. (Table 3; as a supplement, I think; Columns: Site, forest, elevation, rep, CWD, surveyed area, survey date).

We preprogrammed transect paths using Map Pilot for DJI on iOS (hereafter Map Pilot) [@dronesmadeeasy2018]. All transects tracked the terrain and their altitude remained approximately constant at 120 meters above ground level in order to maintain consistent ground sampling distance in the imagery. Ground level was based on a 1-arc-second digital elevation model [@farr2007] and we implemented terrain following using Map Pilot. For this analysis, we dropped 4 sites whose imagery was of insufficient quality to process.

Structure from motion (SfM) processing requires highly overlapping images, especially in densely vegetated areas. We planned transects with 90% forward overlap and 90% side overlap at 100 meters below the lens. Thus, with flights being at 120 meters above ground level, we achieved slightly higher than 90/90 overlap for objects 20 meters tall or shorter (91.6/91.6 overlap at the ground). Overlap values were based on focal length (3.6mm), sensor width (6.2mm), and image dimension (4000x3000 pixels) parameters of the Zenmuse X3 camera. Images were captured at a constant rate of 1 image every 2 seconds for both cameras. A forward overlap of 90% at 100 meters translates to a flight speed of approximately 6.45 m/s and a side overlap of 90% at 100 meters translates to transects approximately 17.2 meters apart. The Rededge camera has a different focal length (5.4mm), sensor width (4.8mm), and image dimension (1280x960 pixels), which translates to image overlap of 80.7/80.7 at 100m below the lens and 83.9/83.9 at ground level. Approximately 1900 photos were captured over each 40 hectare survey area for each camera.

### Structure from motion/Photogrammetric processing

We used structure from motion (SfM), aka photogrammetry, to generate orthorectified reflectance maps, digital surface models, and dense point clouds for each field site. We used Pix4Dmapper Cloud to process imagery using parameters ideal for images of a densely vegetated area taken by a multispectral camera. For three sites, we processed the RGB and the multispectral imagery in the same project to enhance the resolution of the dense point cloud. All SfM projects resulted in a single processing "block," indicating that all images in the project were optimized and processed together.

### Creating canopy height models

We classified each survey area's dense point cloud into "ground" and "non-ground" points using a cloth simulation filter algorithm [@zhang2016] implemented in the `lidR` [@roussel2019] package. We rasterized the ground points using the `raster` package [@hijmans2019] to create a digital terrain model representing the ground underneath the vegetation at 1 meter resolution. We created a canopy height model by subtracting the digital terrain model from the digital surface model created in Pix4Dmapper.

### Tree detection

We tested a total of `r nrow(algorithm_summary)` automatic tree detection algorithms and a total of `r sum(algorithm_summary$n)` parameter sets on the canopy height model or the dense point cloud to locate trees within each site (Table 2). We used `r algorithm_summary %>% dplyr::filter(algorithm == "vwf") %>% pull(n)` parameter sets of a variable window filter implmented in `ForestTools` [@plowright2018] including the default variable window filter function in `ForestTools` as well as the "pines" and "combined" functions from @popescu2004. We used `r algorithm_summary %>% dplyr::filter(algorithm == "localMaxima") %>% pull(n)` parameter sets of a local maximum filter implemented in `lidR`. We used `r algorithm_summary %>% dplyr::filter(algorithm == "li2012") %>% pull(n)` parameter sets of the algorithm from @li2012, which operates on the original point cloud. These parameter sets included those from @shin2018 and @jakubowski2013. We used `r algorithm_summary %>% dplyr::filter(algorithm == "watershed") %>% pull(n)` parameter sets of the `watershed` algorithm implemented in `lidR`, which is a wrapper for a function in the `EBImage` package [@pau2010]. We used `r algorithm_summary %>% dplyr::filter(algorithm == "ptrees") %>% pull(n)` parameter sets of `ptrees` [@vega2014] implemented in `lidR` [@roussel2019] and `lidRplugins` [@roussel2019a] and which operates on the raw point cloud, without first normalizing it to height above ground level (i.e.. subtracting the ground elevation from the dense point cloud). We used the default parameter set of the `multichm` [@eysn2015] algorithm implmented in `lidR` [@roussel2019] and `lidRplugins` [@roussel2019a]. We used `r algorithm_summary %>% dplyr::filter(algorithm == "lmfx") %>% pull(n)` parameter sets of the experimental algorithm `lmfx` [@roussel2019a].

```{r algorithm_summary_print, echo = FALSE, include = TRUE, results = 'asis'}
algorithm_summary_print <-
  algorithm_summary %>% 
  dplyr::rename(`Parameter sets\ntested` = n,
                Algorithm = algorithm) %>%
  dplyr::mutate(`Reference(s)` = c("@li2012; @jakubowski2013; @shin2018", "@roussel2019a", "@roussel2019", "@eysn2015", "@vega2014", "@plowright2018", "@pau2010"))

pandoc.table(algorithm_summary_print, 
             split.tables = Inf,
             caption = "Algorithm name, number of parameter sets tested for each algorithm, and references.",
             keep.line.breaks = TRUE)
```

### Map ground data

Each orthorectified reflectance map was inspected to locate the 5 orange "X"s marking the center of the field plots. We were able to locate 110 out of 180 field plots and were then able to use these plots for validation of automated tree detection algorithms. We used the `sf` package [@pebesma2019] to convert distance-from-center and azimuth measurements of each tree in the ground plots to an x-y position on the SfM-derived reflectance map using the x-y position of the orange X visible in the reflectance map as the center.

### Correspondence of automatic tree detection with ground data

We calculated 7 forest structure metrics for each field plot using the ground data collected by @fettig2019: total number of trees, number of trees greater than 15 meters, mean height of trees, 25^th^ percentile tree height, 75^th^ percentile tree height, mean distance to nearest tree neighbor, mean distance to 2^nd^ nearest neighbor.

For each tree detection algorithm and parameter set described above, we calculated the same set of 7 structure metrics within the footprint of the validation field plots. We calculated the Pearson's correlation and root mean square error (RMSE) between the ground data and the aerial data for each of the 7 structure metrics for each of the `r sum(algorithm_summary$n)` automatic tree detection algorithms/parameter sets.

For each algorithm and parameter set, we calculated its performance relative to other algorithms as whether its Pearson's correlation was within 5% of the highest Pearson's correlation as well as whether its RMSE was within 5% of the lowest RMSE. For each algorithm/parameter set, we summed the number of forest structure metrics for which it reached these 5% thresholds. For automatically detecting trees across the whole study, we selected the algorithm/parameter set that performed well across the most number of forest metrics.

### Segmentation of crowns

We delineated individual tree crowns with a marker controlled watershed segmentation algorithm [@meyer1990] using the detected treetops as markers implemented in the `ForestTools` package [@plowright2018]. If the automatic segmentation algorithm failed to generate a crown segment for a detected tree (e.g., often snags with a very small crown footprint), a circular crown was generated with a radius of 0.5 meters. If the segmentation generated multiple polygons for a single detected tree, only the polygon containing the detected tree was retained. Image overlap decreases near the edges of the overall flight path, which reduces the quality of the SfM processing in those areas. Thus, we excluded segmented crowns within 35 meters of the edge of the survey area. Given the narrower field of view of the RedEdge multispectral camera versus the X3 RGB camera whose optical parameters were used to define the ~40 hectare survey area around each site, as well as the 35 meter additional buffering, the survey area at each site was approximately 30 hectares (Table 3).

We used the `velox` package [@hunziker2017] to extract all the pixel values from the orthorectified reflectance map for each of the 5 narrow bands within each segmented crown polygon. Per pixel, we additionally calculated the normalized difference vegetation index (NDVI; @rouse1973), the normalized difference red edge (NDRE; @gitelson1994), the red-green index (RGI; @coops2006), the red edge chlorophyll index (CI[red edge]; @clevers2013), and the green chlorophyll index (CI[green]; @clevers2013). For each crown polygon, we calculated the mean value for each raw and derived reflectance band (5 raw; 5 derived).

### Classification of trees

We overlaid the segmented crowns on the reflectance maps from `r length(unique(hand_classified_crowns$site))` sites spanning the latitudinal and elevational gradient in the study. Using QGIS, we hand classified `r nrow(hand_classified_crowns)` trees as live/dead and as one of 5 dominant species in the study area (*Pinus ponderosa*, *Pinus lambertiana*, *Abies concolor*, *Calocedrus decurrens*, or *Quercus kelloggi*) using the mapped ground data as a guide. 

We used all 10 mean values of the reflectance bands for each tree crown polygon to predict whether the hand classified trees were alive or dead using a boosted logistic regression model implemented in the `caret` package (accuracy of live/dead classification on a witheld test dataset: `r round(classifier_stats[classifier_stats$type == "live/dead", "accuracy"] %>% pull() * 100, 1)`%) [@kuhn2008]. For just the living trees, we similarly used all 10 reflectance values to predict the tree species using regularized discriminant analysis implemented in the `caret` package (accuracy of species classification on a witheld testing dataset: `r round(classifier_stats[classifier_stats$type == "species", "accuracy"] %>% pull() * 100, 1)`%; accuracy of WPB host/non-WPB-host (i.e., ponderosa pine versus other tree species) on a witheld testing dataset: `r round(classifier_stats[classifier_stats$type == "host/non-host", "accuracy"] %>% pull() * 100, 1)`%).

Finally, we used these models to classify all tree crowns in the data set as alive or dead as well as the species of living trees.

### Allometric scaling of height to basal area

We converted the height of each tree determined using the canopy height model to its basal area. Using the tree height and diameter at breast height (DBH; breast height = 1.37m) ground data from @fettig2019, we fit a simple linear regression to predict DBH from height for each of the 5 dominant species. Using the model-classified tree species of each segmented tree, we used the corresponding linear relationship for that species to estimate the DBH given the tree's height. We then calculated each tree's basal area, assuming no tapering from breast height. 

### Note on assumptions about dead trees

For the purposes of this study, we assumed that all dead trees were ponderosa pine and were thus host trees for the western pine beetle. This is a reasonably good assumption, given that @fettig2019 found that `r pipo_pct_of_all_dead`% of the dead trees in the coincident ground plots were ponderosa pine. The species contributing to the next highest proportion of dead trees was incense cedar which represented `r cade_pct_of_all_dead`% of the dead trees in the ground plots. Incense cedar is not a potential host of the western pine beetle, and we expand on the limitations of this study given the assumption of dead trees being ponderosa pine in the Discussion.

### Rasterizing individual tree data

Because the tree detection algorithms were validated against ground data at the plot level, we rasterized the classified trees at a spatial resolution similar to that of the ground plots (rasterized to 20m x 20m equalling 400 m^2^; circular ground plots with 11.35m radius equalling 404 m^2^). In each raster cell, we calculated the: number of live trees, number of dead trees, number of ponderosa pine trees, total number of trees (of all species, including ponderosa pine), quadratic mean diameter (QMD) of ponderosa pine trees, and QMD of all trees of any species (overall QMD). We converted the count of ponderosa pine trees and the total tree count to a density measurement of trees per hectare (tpha) by multiplying the counts in each 20m x 20m cell by `r 10000/400` to create a "host density" and an "overall density" variable per cell.

### Environmental data

We used climatic water deficit (CWD) [@stephenson1998] from the 1981-2010 mean value of the basin characterization model [@flint2013] as an integrated measure of temperature and moisture conditions for each cell. Higher values of CWD correspond to hotter, drier conditions and lower values correspond to cooler, wetter conditions CWD has been shown to correlate well with broad patterns of tree mortality in the Sierra Nevada [@young2017]. We resampled the climatic water deficit product using bilinear interpolation implemented in the `raster` package to match the 20m x 20m spatial scale of the other variables. We converted the CWD value for each cell into a z-score representing that cell's deviation from the mean CWD across the climatic range of Sierra Nevada ponderosa pine as determined from 179 herbarium records described in @baldwin2017a. Thus, a CWD z-score of one would indicate that the CWD at that cell is one standard deviation hotter/drier than the mean CWD across all geolocated herbarium records for ponderosa pine in the Sierra Nevada.

### Statistical model

We used a generalized linear model with a zero-inflated binomial response and a logit link to predict the probability of ponderosa pine mortality within each raster cell as a function of the crossed effects of ponderosa pine quadratic mean diameter and density added to the crossed effect of overall quadratic mean diameter and density as well as the interaction of each summand with climatic water deficit at each site. 

To measure and account for spatial autocorrelation of the bark beetle behavioral processes underlying ponderosa mortality, we first subsampled the data at each site to a random selection of 200, 20m x 20m cells representing approximately 27.5% of the surveyed area. With these subsampled data, we included a separate exact Gaussian process term per site of the interaction between the x- and y-position of each cell using the `gp()` function in the `brms` package [@burkner2017]. The Gaussian process accounts for spatial autocorrelation in the model by jointly estimating the spatial covariance of the response variable with the effects of the other covariates.

$$
\begin{aligned}
y_{i,j} \sim &\ \begin{cases}
0, & p \\
Binom(n_i, \pi_i), & 1-p
\end{cases} \\
logit(\pi_i) = &\ \beta_0\ + \\
& \beta_1X_{cwd, j}\ + \\
& \beta_1X_{cwd, j}(\beta_2X_{pipoQMD, i} + \beta_3X_{pipoDensity, i} + \beta_4X_{pipoQMD, i}X_{pipoDensity, i})\ + \\ 
& \beta_1X_{cwd, j}(\beta_5X_{overallQMD, i} + \beta_6X_{overallDensity, i} + \beta_7X_{overallQMD, i}X_{overallDensity, i})\ + \\
& \mathcal{GP}_j(x_i, y_i) \\
\end{aligned}
$$

Where $y_i$ is the number of dead trees in cell $i$, $n_i$ is the sum of the dead trees and live ponderosa pine trees in cell $i$, $\pi_i$ is the probability of ponderosa pine tree mortality in cell $i$, $p$ is the probability of there being zero dead trees in a cell arising as a result of an unmodeled process, $X_{cwd, j}$ is the z-score of climatic water deficit for site $j$, $X_{pipoQMD, i}$ is the scaled quadratic mean diameter of ponderosa pine in cell $i$, $X_{pipoDensity, i}$ is the scaled density of ponderosa pine trees in cell $i$, $X_{overallQMD, i}$ is the scaled quadratic mean diameter of all trees in cell $i$, $X_{overallDensity, i}$ is the scaled density of all trees in cell $i$, $x_i$ and $y_i$ are the x- and y- coordinates of the centroid of the cell in an EPSG3310 coordinate reference system, and $\mathcal{GP}_j$ represents the exact Gaussian process describing the spatial covariance between cells at site $j$.

We used 4 chains with 2000 iterations each (1000 warmup, 1000 samples), and confirmed chain convergence by ensuring all `Rhat` values were less than 1.1 [@brooks1998]. We used posterior predictive checks to visually confirm model performance by overlaying the density curves of the predicted number of dead trees per cell over the observed number [@gabry2019]. For the posterior predictive checks, we used 50 random samples from the model fit to generate 50 density curves and ensured curves were centered on the observed distribution, paying special attention to model performance at capturing counts of zero.

### Software and data availability

All data are available via the Open Science Framework. Statistical analyses were performed using the `brms` packages. With the exception of the SfM software (Pix4Dmapper Cloud) and the GIS software QGIS, all data carpentry and analyses were performed using `R` [@rcoreteam2018].

## Results

```{r site_characteristics_read_file}
site_characteristics <- read_csv(here::here("analyses/analyses_output/summarized-non-spatial-site-data.csv"))
```

```{r site_characteristics, echo = FALSE, include = TRUE, results = 'asis'}
site_characteristics <- 
   site_characteristics %>% 
  tidyr::separate(site, into = c("Forest", "Elevation band", "Rep"), remove = FALSE) %>% 
  dplyr::mutate(`Mortality\n(aerial/ground)` = paste(sprintf("%0.2f", prop_mortality), sprintf("%0.2f", ground_mortality), sep = "/"),
                `Density\n(tpha; aerial/ground)` = paste(sprintf("%0.2f", air_tpha), sprintf("%0.2f", ground_tpha), sep = "/")) %>% 
  dplyr::rename(`CWD\n(mm)` = site_cwd,
                `CWD\n(z-score)` = site_cwd_zscore,
                `Survey area\n(ha)` = buffered_survey_area,
                Site = site) %>% 
  dplyr::mutate(Forest = case_when(Forest == "eldo" ~ "Eldorado",
                                   Forest == "stan" ~ "Stanislaus",
                                   Forest == "sier" ~ "Sierra",
                                   Forest == "sequ" ~ "Sequoia")) %>% 
  dplyr::mutate(Forest = factor(Forest, levels = c("Eldorado", "Stanislaus", "Sierra", "Sequoia"))) %>% dplyr::arrange(Forest, `Elevation band`, Rep) %>% 
  dplyr::select(Site, `CWD\n(mm)`, `CWD\n(z-score)`, `Survey area\n(ha)`, `Mortality\n(aerial/ground)`, `Density\n(tpha; aerial/ground)`)

pandoc.table(site_characteristics, 
             digits = c(10, 3, 3, 4, 10, 10), 
             split.tables = Inf,
             caption = "Site characteristics for each of the 32 sites. The site name consists of the forest name, elevation band, and rep separated by an underscore. The Eldorado National Forest is 'eldo', the Stanislaus National Forest is 'stan', the Sierra National Forest is 'sier', and the Sequoia National Forest is 'sequ'. The elevation band represents the lower bounds of the 305 meter (1000 foot) elevation bands in feet. Thus '3k' implies that site was located between 3,000 and 4,000 feet (914-1219 meters). Aerially detected mortality and density of the whole site is presented along with the mortality and density calculated from the ground data (aerial / ground). The density is measured in trees per hectare (tpha).",
             keep.line.breaks = TRUE)
```

![A dense point cloud representing ~40 hectares of forest is generated using Structure from Motion (SfM) processing of ~1900 images. The dense point cloud z- position represents the ground elevation plus the vegetation height.](../../figures/eldo_3k_3_point_cloud.png)

![The digital surface model (DSM) is a 2-dimensional representation of the dense point cloud generated using structure from motion (SfM) processing. The DSM represents the ground elevation plus the vegetation height.](../../figures/eldo_3k_3_dsm.png)

![The digital terrain model (DTM) is generated by processing the dense point cloud using the cloth simulation filter algorithm [@zhang2016], which classifies points as "ground" or "not-ground" and then interpolates the "ground" elevation using Delaunay triangulation for the rest of the dense point cloud footprint. The DTM represents the ground elevation without any vegetation.](../../figures/eldo_3k_3_dtm.png)

![The canopy height model (CHM) is generated by subtracting the digital terrain model from the digital surface model. The CHM represents the height of all of the elevation above ground level.](../../figures/eldo_3k_3_chm.png)

![Tree locations are detected using the `lmfx` [@roussel2019] treetop detection algorithm on the dense point cloud.](../../figures/eldo_3k_3_ttops.png)

![Individual crowns are delineated using a marker controlled watershed segmentation algorithm [@meyer1990; @plowright2018] on the canopy height model (CHM) using the detected tree locations as a priority map. If the algorithm failed to delineate a crown for a tree that was identified in the tree detection step, a circular crown with a 0.5m buffer centered on point location of the detected tree was added as a crown.](../../figures/eldo_3k_3_crowns.png)

![The orthomosaic for each of the 32 sites is generated with the Structure from Motion (SfM) processing, showing a top-down view of the whole survey area such that distances between objects in the scene are preserved and can be measured. Depicted is an example orthomosaic for one of the 32 sites cropped to the extent of a single ground plot (5 ground plots per site) showing the orange X placed at exactly the plot center prior to flight. The original orthomosaic for the whole site represents an area approximately 1000 times as large as the area depicted here.](../../figures/eldo_3k_3_2_ortho-rgb.png)

![Each tree is classified as live or dead by extracting the pixel values from the 5 narrow bands of the Rededge3 camera (and 5 derived bands-- see methods) in the orthomosaic within each segmented tree crown of the detected trees, taking their mean value, and using those means to predict live/dead status with a boosted logistic regression previously trained on a hand-classified set of segmented crowns from across the study area.](../../figures/eldo_3k_3_live_dead.png)

![We rasterized the individual tree data by aggregating values to 20m x 20m cells. This example shows the proportion of dead trees per cell for the same example site as in the previous figures.](../../figures/proportion-dead-rasterized.png)

![For each live tree, we classified its species using the same means of extracted pixel values across the 5 Rededge3 narrow bands (and 5 derived bands) as predictors in a regularized discriminant analysis previously trained on a hand-classified set of segmented crowns from across the study area. Host/non-host data were also rasterized as in the previous figure prior to analyses (not shown).](../../figures/eldo_3k_3_host_nonhost.png)

![Posterior distributions of effect size from zero-inflated binomial model predicting the probability of ponderosa pine mortality in a 20m x 20m cell given forest structure characteristics of host trees and all trees within the cell, as well as a site-level climatic water deficit. The gray density distribution for each model covariate represents the density of the posterior distribution, the point underneath each density curve represents the median of the estimate, the bold interval surrounding the point estimate represents the 66% credible interval, and the thin interval surrounding the point estimate represents the 95% credible interval.](../../figures/effect-sizes-halfeye.png)

![Line version of model results with 95% credible intervals showing primary influence of ponderosa pine structure on the probability of ponderosa pine mortality, and the interaction across climatic water deficit. The "larger trees" line represents the quadratic mean diameter of ponderosa pine 0.7 standard deviations above the mean, and the "smaller trees" line represents the quadratic mean diameter of ponderosa pine 0.7 standard deviations below the mean.](../../figures/pipo_tpha_qmd_cwd_interaction.png)

### Tree detection

We found that the experimental `lmfx` algorithm with parameter values of `dist2d = `r algorithm_details[1, "var1_val"]`` and `ws = `r algorithm_details[1, "var2_val"]`` [@roussel2019] performed the best across 7 measures of forest structure as measured by Pearson's correlation with ground data (Table 3).

```{r best_algorithm_deets_table, echo = FALSE, include = TRUE, results = 'asis'}
best_algorithm_deets_print <-
  best_algorithm_deets %>% 
  ungroup() %>% 
  dplyr::select(forest_metric, ground_correlation, rmse, me, med_error, ground_cor_within_threshold_pct, rmse_within_threshold_pct) %>% 
  dplyr::mutate(ground_correlation = ifelse(ground_cor_within_threshold_pct == 1, yes = paste0(as.character(sprintf("%0.2f", ground_correlation)), "*"), no = as.character(sprintf("%0.2f", ground_correlation)))) %>% 
  dplyr::mutate(rmse = ifelse(rmse_within_threshold_pct == 1, yes = paste0(as.character(sprintf("%0.2f", rmse)), "*"), no = as.character(sprintf("%0.2f", rmse)))) %>% 
  dplyr::select(forest_metric, ground_correlation, rmse, me, med_error) %>% 
  dplyr::mutate(forest_metric = c("height (m); 25th percentile",
                                  "height (m); mean",
                                  "height (m); 75th percentile",
                                  "dist to 1st nearest neighbor (m)",
                                  "dist to 2nd nearest neighbor (m)",
                                  "dist to 3rd nearest neighbor (m)",
                                  "total tree count",
                                  "count of trees > 15m",
                                  "count of trees < 15m")) %>% 
  dplyr::rename(`Forest structure metric` = forest_metric,
                `Correlation with ground` = ground_correlation,
                RMSE = rmse,
                `Mean error` = me,
                `Median error` = med_error) %>% 
  dplyr::mutate(sort = c(7:9, 4:6, 1:3)) %>% 
  dplyr::arrange(sort) %>% 
  dplyr::mutate(`Ground mean` = t(ground_tree_summary_print)[, 1]) %>% 
  dplyr::select(`Forest structure metric`,
                `Ground mean`,
                `Correlation with ground`,
                RMSE,
                `Median error`) %>% 
  dplyr::filter(`Forest structure metric` %in% 
                  c("height (m); 25th percentile",
                    "height (m); mean",
                    "height (m); 75th percentile",
                    "dist to 1st nearest neighbor (m)",
                    "dist to 2nd nearest neighbor (m)",
                     "total tree count",
                    "count of trees > 15m"))

pandoc.table(best_algorithm_deets_print, 
             digits = 2, 
             split.tables = Inf,
             caption = paste0("Correlation and differences between the best performing tree detection algorithm (lmfx with dist2d = ", algorithm_details[1, "var1_val"], " and ws = ", algorithm_details[1, "var2_val"], ") and the ground data. An asterisk next to the correlation or RMSE indicates that this value was within 5% of the value of the best-performing algorithm/parameter set. Ground mean represents the mean value of the forest metric across the 110 ground plots that were visible from the sUAS-derived imagery. The median error is calculated as the median of the differences between the air and ground values for the 110 visible plots. Thus, a positive number indicates an overestimate by the sUAS workflow and a negative number indicates an underestimate."),
             keep.line.breaks = TRUE)
```

### Effect of local structure and regional climate on western pine beetle severity

We detected no main effect of climatic water deficit on the probability of ponderosa pine mortality within each 20m x 20m cell. 

We found a strong main effect of ponderosa pine local density, accounting for quadratic mean diameter of ponderosa pine, with greater density increasing the probability of ponderosa pine mortality. 

Conversely, we found a generally negative effect of quadratic mean diameter of ponderosa pine on the probability of ponderosa mortality, suggesting that the western pine beetle attacked smaller trees, on average. There was a strong positive interaction between the climatic water deficit and ponderosa pine quadratic mean diameter, such that larger trees were more likely to increase the probability of ponderosa mortality in hotter, drier sites.

We found negative main effects of overall tree density and overall quadratic mean diameter. There was a positive interaction between these variables, such that denser stands with larger trees did lead to greater ponderosa pine mortality.

### Spatial effects

We were able to calculate the length scale of the spatial autocorrelation in the probability of ponderosa pine mortality at each site, accounting for forest structure and environmental factors. By fitting a separate approximate Gaussian process for each site on the interacting variables of the x- and y- position, we measured the spatial covariance inherent in the data, accounting for other factors. 

## Discussion

Climate change adaptation strategies emphasize reducing tree densities [@north2015; @young2017], but understanding the optimal scale and pattern of tree distributions that can mitigate bark beetle outbreaks will be vital for predicting how California forests may respond to these interventions. 


that rapidly emerge over weeks to months but have long-lasting effects on forest conditions. 

and limit insights into phenomena like the recent bark beetle disturbance in Sierra yellow pine/mixed-conifer forests.

### Closer spacing between potential host trees facilitates dispersal

If this drives mortality patterns, then we'd expect the local density of ponderosa pine trees, accounting for other variables, to have a strong positive effect.

### Host preference for large trees

If this drives mortality patterns, then we'd expect the quadratic mean diameter of ponderosa pine trees, accounting for other variables, to have a strong positive effect.

### Denser forests augment pheromone communication

If this drives mortality patterns, then we'd expect the local density of all trees, accounting for other variables, to have a strong positive effect.

### Tree crowding leads to greater average water stress per tree

If this drives mortality patterns, then we'd expect the quadratic mean dimater of all trees, accounting for other factors, to have a strong positive effect.

### Interaction between host density and host size

A positive coefficient would indicate a combined effect of WPB preference for large trees and nearby host availability.

### Interaction between all tree density and all tree size 

A positive coefficient would indicate a combined effect of tree crowding and pheromone communication enhancement.

### Implications of forest structure/regional climate interactions

We found that the probability of ponderosa pine mortality generally increased with local host availability (host density), but also interacted with both host size and regional climate such that the role of tree size became increasingly important in more climatically extreme sites. A smaller average tree size led to a lower probability of ponderosa mortality in cool/wet sites and a larger average tree size led to a greater probability of ponderosa mortality in hot/dry sites. These mortality patterns highlight a possible distinction in behavior between the recent western bark beetle activity across the gradient of climatic water deficit. Even in the most highly impacted forest stands (because our study sites were selected conditional on there being high levels of western pine beetle activity), there is still a detectable effect of tree size such that the smaller (presumably weaker) trees are getting killed in cooler/wetter sites, and the larger (presumably more well-defended) trees are getting killed more in the hotter/drier sites. So while mortality is high everywhere, there does appear to be a difference in the beetle choosiness across the climatic water deficit gradient.

### Similarities and differences with @fettig2019

@fettig2019 found positive relationship between number of trees killed and: total number of trees, total basal area, stand density index.

@fettig2019 found negative relationship between the proportion of trees killed and: total number of trees, stand density index.

Host availability and suitability are usually considered the major factors affecting beetle population behavior (Reid 1963; Berryman1973,
1976,1978a,1982a;Cole 1981;Amman1984). [@raffa1987]

@hayes2009 and @fettig2019 found measures of host availability explained less variation in mortality than measures of stand density.

@negron2009 reported positive association of probability of ponderosa pine mortality and tree density during a drought in Arizona.

Effect of competition may be masked because drought was so extreme @fettig2019; @floyd2009, which is perhaps why we saw a counter-intuitive signal of increasing total basal area leading to lower probability of ponderosa pine mortality.

### Broader context around field plots

We surveyed 9 square kilometers of forest representing ~450,000 trees along a broad environmental gradient of climatic water deficit. Site selection and small plot size can influence inference. For instance, @fettig2019 reported statistically undetectable differences in overall mortality in their plot network across 4 national forests. By expanding the hectarage surveyed by a factor of 200, we detected dramatic differences in overall mortality.

This is about more than sample size (though that helps). This is also about capturing the local disturbance phenomenon.

### Implications for future forest structure

We have demonstrated that forest structure (local host density and size) affected the cumulative severity of the western pine beetle in the Sierra Nevada in the 2012 to 2015 drought and its aftermath. Clearly, this forest insect disturbance has reciprically impacted the forest structure, with uncertain consequences for long-term forest dynamics. 

Small trees are getting killed in cooler/wetter sites, larger trees getting killed in hotter/drier sites. Perhaps the cooler/wetter sites are resisting even this massive disturbance event?

### Spatial effect

The western pine beetle is known to exhibit strong aggregation and anti-aggregation behavior arising from its pheromone communication, and thus it is likely that the measured spatial covariance in this study is attributable in part to the magnitude of this effect at each site. 

Some studies have suggested that "outbreak" conditions are distinguishable by clustered tree mortality, but this is perhaps challenging to tease apart [@raffa2008]. Our modeling framework allows for a joint estimation of the effects of forest structure, environmental condition, and the spatial effect. This framework would be enhanced with confidence in individual tree level data, and a lot of it, along with a strong gradient of environmental conditions and forest structure.

We won't interpret this measure of contagion, because the uncertainties in this particular study are too great (tree detection, species classification, dead trees all assumed to be WPB hosts, didn't account for topographic effects which could also manifest as part of this spatial covariance process). We do suggest that this could be a meaningful and quantifiable means of assessing bark beetle "stage of outbreak".

### Future spatial directions (will cut this; here for now so I can write it down elsewhere)

Perhaps could also compare relative effect of individual tree spacing (Voronoi polygon area) with the length scale parameter at a certain site to get at a similar question. A big voronoi polygon area effect and a short covariance kernel tells us that it's a water stress effect-- a crowded tree gets attacked regardless of whether nearby trees were attacked. A small voronoi polygon area effect and a long covariance kernel tells us that the mortality is patterned more based on there being spillover from nearby attacked neighbors instead of how crowded any given tree is. I expect we might see different relative magnitudes of voronoi polygon area and covariance kerenel effects depending on CWD.

### Important considerations

Cumulative effect of elevated insect activity, as mortality was spread out over 5 years and we surveyed at the end. All the detected dead trees were considered ponderosa pine-- we know this is wrong. Only about 3 out of 4 dead trees in @fettig2019 were ponderosa. 

### Room for improvement

- Better geometry by using higher overlap, more spatially resolved images.
- Better image classification and scalability by using instrumentation having spectral overlap with more widely deployed instrumentation (e.g., Landsat).
- Better tree detection using machine learning approaches
- Our live/dead classifier works pretty well. 
- Our species classifier could improve. Perhaps also using machine learning approaches.

[@preisler2017]



## References