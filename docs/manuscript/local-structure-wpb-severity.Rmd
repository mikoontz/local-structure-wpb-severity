---
bibliography: ../docs_carpentry/local-structure-wpb-severity.bib
csl: ../docs_carpentry/ecological-applications.csl
params:
  title: Differential response of a tree-killing bark beetle to forest structure and composition across a gradient of climatic water deficit
  author: |
    Michael J. Koontz^1,2,3\*^,
    Andrew M. Latimer^1,2^,
    Leif A. Mortenson^4^,
    Christopher J. Fettig^5^,
    Malcolm P. North^1,2,6^
  affiliation: |
    ^1^Graduate Group in Ecology, University of California, Davis, CA, USA  
    ^2^Department of Plant Sciences, University of California, Davis, CA, USA  
    ^3^Earth Lab, University of Colorado-Boulder; Boulder, CO, USA  
    ^4^USDA Forest Service, Pacific Southwest Research Station, Placerville, CA, USA  
    ^5^USDA Forest Service, Pacific Southwest Research Station, Davis, CA, USA  
    ^6^USDA Forest Service, Pacific Southwest Research Station, Mammoth Lakes, CA, USA
  correspondence: |
    michael.koontz@colorado.edu
  keywords: |
    bark beetles, forest structure, drones, climatic water deficit, Sierra Nevada, California, disturbance, structure from motion, *Dendroctonus brevicomis*, *Pinus ponderosa*, threshold dynamics
  date_generated: !r format(Sys.Date(), "%B %d, %Y")
  
geometry: margin=1in
header-includes:
  - \usepackage[left]{lineno}
  - \linenumbers
  - \usepackage{setspace}
  - \doublespacing
  - \DeclareUnicodeCharacter{200E}{}
  - \usepackage{caption}
  - \captionsetup[figure]{labelformat=empty}
  - \captionsetup[table]{labelformat=empty}

output: pdf_document
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

```{r libraries}
library(tidyverse)
library(pander)
library(captioner)
```

```{r captions}
fig_nums <- captioner(prefix = "Figure")
table_nums <- captioner(prefix = "Table")
eq_nums <- captioner(prefix = "Equation")
```

```{r source_necessary_scripts}
# Information about correspondence of tree top detection algorithms with ground data
algorithm_stats <- read_rds(here::here("analyses/analyses_output/algorithm_stats.rds"))
best_algorithm_deets <- algorithm_stats$best_algorithm_deets
algorithm_details <- algorithm_stats$algorithm_details
algorithm_summary <- algorithm_stats$algorithm_summary

d <- read_csv(here::here("data/data_output/formatted-ground-data.csv"))
```

```{r ground_data_deets}
pipo_pct_of_all_dead <-
  d %>%
  dplyr::filter(is.na(year_fall), !is.na(year_dead)) %>%
  group_by(species) %>%
  summarize(n = n(),
            prop_of_all_dead = n() / nrow(.),
            print_prop = round(prop_of_all_dead * 100, digits = 2)) %>%
  dplyr::filter(species == "PIPO") %>%
  pull(print_prop)

cade_pct_of_all_dead <-
  d %>%
  dplyr::filter(is.na(year_fall), !is.na(year_dead)) %>%
  group_by(species) %>%
  summarize(n = n(),
            prop_of_all_dead = n() / nrow(.),
            print_prop = round(prop_of_all_dead * 100, digits = 2)) %>%
  dplyr::filter(species == "CADE") %>%
  pull(print_prop)
```

```{r ground_tree_summary}
ground_tree_summary <- readr::read_csv(here::here("analyses/analyses_output/ground-tree-summary.csv"))

ground_tree_summary_print <-
  ground_tree_summary %>% 
  summarize(mean_total_count = mean(total_tree_count),
            mean_short_count = mean(tree_count_below_15m),
            mean_tall_count = mean(tree_count_above_15m),
            mean_nn1 = mean(nn_1_mean),
            mean_nn2 = mean(nn_2_mean),
            mean_nn3 = mean(nn_3_mean),
            mean_short_height = mean(height_lwr_25),
            mean_height = mean(height_mean),
            mean_tall_height = mean(height_upr_25))

```


```{r classifier_stats}
classifier_stats <- read_csv(here::here("analyses/analyses_output/classification-summary-stats.csv"))
```

```{r hand_classified_crowns}
hand_classified_crowns <- read_csv(here::here("data/data_output/classified/hand-classified/hand-classified-crowns.csv")) %>% 
  dplyr::mutate(site = substr(treeID, start = 1, stop = 9))
```

```{r site_characteristics_read_file}
site_characteristics <- read_csv(here::here("analyses/analyses_output/summarized-non-spatial-site-data.csv"))
```

```{r model-predictions}
model_predictions <- read_csv(here::here("analyses/analyses_output/model-predictions.csv"))
```

```{r feet_to_meters}
# 3000 = 914
# 4000 = 1219
# 5000 = 1524
# 6000 = 1829
# 7000 = 2134
```

# `r params$title`

`r params$author`

`r params$affiliation`

*^\*^Correspondence:* ``r params$correspondence``

*Keywords:* `r params$keywords`

*Abstract word count:* 427  
*Overall .docx word count:* 10925
*Main text word count:* 6493 (Intro: 1249; Methods: 3006 (550+644+1502+310); Results: 341 (41+95+205); Discussion: 1897)  
*Text boxes word count:* 0  

Date report generated: `r params$date_generated`

## Abstract 

The Californian hot drought of 2012 to 2015 created favorable conditions for unprecedented ponderosa pine (*Pinus ponderosa*) mortality in the Sierra Nevada mountain range, largely caused by the western pine beetle (WPB; *Dendroctonus brevicomis*). 

Climate conditions related to tree water stress as well as forest structure and composition can influence the severity of forest insect disturbance, but it remains challenging to consider how these variables may interact to produce patterns of tree mortality. 

Previous studies have shown an interaction between climate conditions and forest density in their effect on tree mortality, but density is a coarse gauge of forest structure that can affect western pine beetle behavior in a number of ways. 
Measuring broad-scale climate conditions simultaneously with local forest composition and structure-- tree size and location-- will refine our understanding of how these variables interact, but is generally expensive and/or labor-intensive. 

We use drone surveys over a network of 160 field plots along a 350km and 1000m elevation gradient in western slope Sierra ponderosa pine/mixed-conifer forests and Structure from Motion processing to segment and classify over 450,000 trees over 9km^2^ of forest with WPB-induced tree mortality.

We modeled the probability of ponderosa pine mortality as a function of forest structure and composition variables and their interaction with site-level climatic water deficit, accounting for spatial covariance using exact Gaussian processes.

We found that greater host density strongly increased the probability of host mortality, and greater host size generally decreased the probability of host mortality. 
There was also a strong three-way interaction between host density, host size, and climatic water deficit such that host density and host size tended to synergistically increase the probability of host mortality at hot/dry sites, but denser, smaller trees tended to drive mortality in cool/wet sites.  

Our results demonstrate a variable response of the western pine beetle to complex forest structure and composition across an environmental gradient during the same hot drought, which may indicate forest sites were in different stages of disturbance (from "endemic" to "outbreak") depending on their regional climate. 
Management interventions that reduce host density may decrease the probability of tree mortality attributed to western pine beetles in the future, and our results suggest that focusing these treatments on areas that are most likely to exceed feedback thresholds (i.e., hot/dry sites with many available hosts) will have the best chance of increasing tree survivorship, specifically of larger trees.


## Introduction

Bark beetles dealt the final blow to many of the nearly 150 million trees killed in the California hot drought of 2012 to 2015 and its aftermath [@usdafs2019]. 
A harbinger of climate change effects to come, record high temperatures exacerbated the drought [@griffin2014], which increased water stress on trees [@asner2016], making them more susceptible to colonization by bark beetles [@fettig2012b; @kolb2016]. 
Further, a century of fire suppression policy has enabled forests to grow into dense stands, which also makes them more vulnerable to bark beetles [@fettig2012b]. 
This combination of environmental conditions and forest structural characteristics led to tree mortality events of unprecedented size in the driest, densest forests across the state [@young2017]. 
The mechanisms underlying the link between tree susceptibility to colonization by insects and hot, dry conditions are often directly attributed to tree physiology [@bentz2010], while the link to forest density is multifaceted [@fettig2012b]. 
Because forest density is a coarse metric of the forest features to which bark beetles respond [@raffa2008], our understanding of the connection between forest density and insect disturbance severity could be enhanced with more finely-resolved measures of forest structure as well as explicit consideration of species composition [@fettig2019; @stephenson2019]. 
Finally, the challenge of simultaneously measuring the effects of both local-scale forest features (such as structure and composition) and broad-scale environmental conditions on forest insect disturbance leaves their interaction effect relatively underexplored [@seidl2016a; @stephenson2019; @fettig2019].

The ponderosa pine/mixed-conifer forests in Californiaâ€™s Sierra Nevada region are characterized by regular bark beetle disturbances, primarily by the influence of western pine beetle (*Dendroctonus brevicomis*; WPB) on its host ponderosa pine (*Pinus ponderosa*) [@fettig2016]. 
The WPB is a "primary" bark beetle-- its reproductive success is contingent upon host tree mortality, which itself requires enough beetles to "mass attack" the host tree and overwhelm its defenses [@raffa1983]. 
This Allee effect creates a strong coupling between beetle selection behavior of host trees and host tree susceptibility to colonization [@raffa1983; @logan1998]. 
A key defense mechanism of trees to bark beetle attack is to flood beetle bore holes with resin, which physically expels beetles and may interrupt beetle communication [@franceschi2005; @raffa2015]. 
Under normal conditions, weakened trees with compromised defenses are the most susceptible to colonization and will be the main targets of primary bark beetles like the western pine beetle [@bentz2010; @raffa2015]. 
Under severe water stress, many trees no longer have the resources available to mount a defense [@kolb2016] and thus prolonged drought can often trigger increased bark beetle-induced tree mortality as average tree vigor declines [@bentz2010]. 
As local population density of beetles increases due to successful reproduction within spatially-aggregated weakened trees, as might occur during drought, mass attacks grow in size and become capable of overwhelming formidable tree defenses such that even healthy trees may be susceptible to colonization and mortality [@bentz2010; @raffa2015]. 
Thus, water stress can be a key determinant of whether individual trees are susceptible to bark beetles under many conditions, and this environmental condition may interact with beetle population dynamics to drive tree susceptibility under extreme conditions [@bentz2010; @stephenson2019].

Western pine beetle activity is strongly influenced by forest structure-- the spatial distribution and size of trees-- and tree species composition.
Considering forest structure alone, high-density forests are more prone to bark beetle-induced tree mortality [@fettig2012b] which may arise as greater competition for water resources amongst crowded trees  and thus average tree resistance is lower [@hayes2009], or because smaller gaps between trees protect pheromone plumes from dissipation by the wind and thus enhance intraspecific beetle communication [@thistle2004].
Tree size is another aspect of forest structure that affects bark beetle host selection behavior with smaller trees tending to have lower capacity for resisting attack, and larger trees being a more desirable target on account of their thicker phloem providing greater nutritional content [@chubaty2009; @graf2012].
Considering forest composition alone, WPB activity in the Sierra Nevada range of California is necessarily tied to the regional distribution of its exclusive host, ponderosa pine [@fettig2016]. 
Colonization by primary bark beetles can also depend on the relative frequencies of tree species in a more local area, akin to reduced oligophagous insect herbivory in forests comprising taxonomically distinct tree species compared to monocultures [@jactel2007]. 
The interaction between forest structure and composition also drives WPB activity. For instance, high density forests with high host availability may experience greater beetle-induced tree mortality because dispersal distances between potential host trees are shorter and facilitate successful colonization [@miller1960; @berryman1982; @fettig2007] or because high host availability reduces the chance of individual beetles wasting their limited resources flying to and landing on a non-host tree [@moeck1981; @evenden2014].
Stand-scale measures of forest structure and composition thus paint a fundamentally limited picture of the mechanisms by which these forest characteristics affect bark beetle disturbance, but finer-grain information explicitly recognizing tree size, species, and local tree density should more appropriately capture the ecological processes underlying insect-induced tree mortality.
Additionally, considering the effects of local forest structure and composition with the effects of environmental conditions may help refine our understanding of tree mortality patterns in widespread events such as during the recent California hot drought.

The vast spatial extent of tree mortality in the 2012 to 2015 California hot drought challenges our ability to simultaneously consider how broad-scale environmental conditions may interact with local forest structure and composition to affect the dynamic between bark beetle selection and colonization of host trees, and host tree susceptibility to attack [@anderegg2015a; @stephenson2019].
Measuring local forest structure generally requires expensive instrumentation [@kane2014; @asner2016] or labor-intensive field surveys [@larson2012; @fettig2019; @stephenson2019], which constrains survey extent and frequency.
Small, unhumanned aerial systems (sUAS) enable relatively fast and cheap remote imaging over dozens of hectares of forest, which can be used to measure complex forest structure at the individual tree scale [@morris2017; @shiklomanov2019].
Distributing such surveys across an environmental gradient can overcome the data acquisition challenge inherent in investigating phenomena with both a strong local- and a strong broad-scale component.

We used ultra-high resolution, sUAS-derived remote sensing data over a network of 32 sites in Sierra Nevada ponderosa pine/mixed-conifer forests spanning 1000m of elevation and 350km of latitude (see @fettig2019) and covering a total of 9km^2^ to ask how broad-scale environmental conditions interacted with local, complex forest structure to affect the probability of tree mortality during the cumulative tree mortality event of 2012 to 2018.
We asked:

1. How does host tree density and average host tree size affect WPB-induced tree mortality?

2. How does the density of all tree species (hereafter "overall density") and average tree size of all species (hereafter "overall size") affect WPB-induced tree mortality?

3. How does environmentally-driven tree moisture stress affect WPB-induced tree mortality?

4. Do the effects of forest structure, forest composition, and environmental condition interact to influence WPB-induced tree mortality?

## Methods

### Study system

```{r}
fig_nums(name = "fig-geographic-extent", "The network of field plots spanned a 350 km latitudinal gradient from the Eldorado National Forest in the north to the Sequoia National Forest in the south.
Plots were stratified by three elevation bands in each forest, with the plots in the Sequoia National Forest (the southern-most National Forest) occupying elevation bands 305m above the three bands in the other National Forests in order to capture a similar community composition.")
```

![`r fig_nums("fig-geographic-extent")`](../../figures/study-geographic-extent-inset.png){ height=7in }

We built our study coincident with 160 vegetation/forest insect monitoring plots at 32 sites established between 2016 and 2017 by @fettig2019 (`r fig_nums(name = "fig-geographic-extent", display = "cite")`).
The study sites were chosen to reflect typical west-side Sierra Nevada yellow pine/mixed-conifer forests and were dominated by ponderosa pine trees, *Pinus ponderosa* [@fettig2019].
These established plots were located in WPB-attacked, yellow pine/mixed-conifer forests across the Eldorado, Stanislaus, Sierra and Sequoia National Forests and were stratified by elevation (914-1219 m [3000-4000 ft], 1219-1524 m [4000-5000 ft], 1524-1829 m [5000-6000 ft] above sea level).
In the Sequoia National Forest, the southernmost National Forest in our study, plots were stratified with the lowest elevation band between 1219 and 1524 m (4000-5000 ft) and extended to an upper elevation band of 1829-2134 m (6000-7000 ft) to capture a more similar forest community composition as at the more northern National Forests.
The sites have variable forest structure and plot locations were selected in areas with >35% ponderosa pine basal area and >10% ponderosa pine mortality.
At each site, five 0.041 ha circular plots were installed along transects with 80 to 200m between plots.
In the field, @fettig2019 mapped all stem locations relative to the center of each plot using azimuth/distance measurements.
Tree identity to species, tree height, and diameter at breast height (DBH) were recorded if DBH was greater than 6.35cm.
Year of mortality was estimated based on needle color and retention, if it wasn't directly observed during site visits.
A small section of bark (approximately 625 cm^2^) on both north and south aspects was removed from dead trees to deermine if bark beetle galleries were present. The shape, distribution, and orientation of galleries are commonly used to distingush among bark beetle species [@fettig2016]. In some cases, deceased bark beetles were presetn beneath the bark to supplement identifications based on gallery formation.
During the spring and early summer of 2018, all field plots were revisited to assess whether dead trees had fallen [@fettig2019].

In the typical life cycle of western pine beetles, female WPB initiate host colonization by tunneling through the outer bark and into the phloem and outer xylem where they rupture resin canals.  As a result, oleoresin exudes and collects on the bark surface, as is commonly observed with other bark beetle species. During the early stages of attack, females release an aggregation pheromone component which, in combination with host monoterpenes released from pitch tubes, is attractive to conspecifics [@bedard1969]. An antiaggregation pheromone component is produced during latter stages of host colonization by several pathways, and is thought to reduce intraspecific competition by altering adult behavior to minimize overcrowding of developing brood within the host [@bryers1980]. Volatiles from several nonhosts sympatric with ponderosa pine have been demonstrated to inhibit attraction of WPB [@fettig2015; @shepherd2007]. In California, the WPB can have 2-3 generations in a single year and can often out-compete its congener, the mountain pine beetle, *Dendroctonus ponderosa* (MPB), for the ponderosa pine host especially in larger trees [@miller1960; @fettig2016].

### Aerial data collection and processing

Nadir-facing imagery was captured using a gimbal-stabilized DJI Zenmuse X3 broad-band red/green/blue (RGB) camera [@dji2015] and a fixed-mounted Micasense Rededge3 multispectral camera with five narrow bands [@micasense2015] on a DJI Matrice 100 aircraft [@dji2015a]. 
Imagery was captured from both cameras along preprogrammed aerial transects over ~40 hectares surrounding each of the 36 sites (each of these containing five field plots) and was processed in a series of steps to yield local forest structure and composition data suitable for our statistical analysis. 
Following the call by @wyngaard2019, we establish "data product levels" to reflect the image processing pipeline from raw imagery (Level 0) to calibrated, fine-scale forest structure and composition information on regular grids (Level 4), with each new data level derived from levels below it.
Here, we outline the steps in the processing and calibration pipeline visualized in `r fig_nums("fig-drone-data-levels", display = "cite")`, and include additional details in the Supplemental Methods.

```{r}
fig_nums(name = "fig-drone-data-levels")
```

![](../../figures/drone-data-levels.png){ height=9in }

<!-- \begin{flushleft}\setstretch{1.0} -->
`r paste0(fig_nums("fig-drone-data-levels", display = "cite"), ".")` Schematic of the data processing workflow for a single site with each new data product level derived from data at lower levels. 

Level 0 represents raw data from the sensors. 
From left to right: example broad-band RGB photo from DJI Zenmuse X3 camera, example blue photo from Rededge3 (centered on 475nm), example green photo from Rededge3 (centered on 560nm), example red photo from Rededge3 (centered on 668nm), example near infrared photo from Rededge3 (centered on 840nm), and example red edge photo from Rededge3 (centered on 717nm). 

Level 1 represents basic outputs from the photogrammetric workflow, in this case implemented with Pix4Dmapper. 
From left to right: a dense point cloud visualized in CloudCompare (https://www.danielgm.net/cc/), an orthophoto generated from the RGB camera, and a digital surface model representing the altitude above sea level (ground height + vegetation height) for every cell.

Level 2 represents outputs from photogrammetric processing that have been corrected radiometrically or geometrically. 
From left to right: a radiometrically-corrected surface reflectance map of the red narrow band from the Rededge3 camera, a radiometrically-corrected surface reflectance map of the near infrared narrow band from the Rededge3 camera, a rasterized version of the digital terrain model derived by a geometric correction of the dense point cloud, and a canopy height model derived by subtracting the terrain height from the digital surface model.

Level 3 represents domain-specific information extraction from Level 2 products and is divided into two sub-levels.
Level 3a products are derived using only spectral or only geometric data.
From left to right: a reflectance map of Normalized Difference Vegetation Index (NDVI; @rouse1973) derived using the red and near infrared Level 2 reflectance products, a map of points representing detected trees from the canopy height model with a red polygon highlighting the area presented in more detail for the next two images, a close-up of points representing detected trees, and a close-up of polygons representing segmented tree crowns.
Level 3b products are derived using both spectral and geometric data.
From left to right: a map of the point locations of detected trees that have been classified as alive or dead based on the pixel values within each segmented tree crown and a map of the point locations of detected trees classified to WPB host/non-host using the same spectral information.
Note that our study relies on the generation of Level 3a products in order to combine them and create Level 3b products, but this need not be the case.
For instance, deep learning/neural net methods may be able to use both the spectral and geometric information from Level 2 simultaneously to locate and classify trees in a scene and directly generate Level 3b products without a need to first generate the Level 3a products shown in this schematic.

Level 4 represents aggregations of Level 3 products to regular grids which might better reflect the grain size of the data for which we have the best calibration and thus the most confidence or which might provide new information not possible at an individual-tree level (e.g., average distance between trees in a small neighborhood)
From left to right: aggregation of live/dead classified trees as fraction of dead trees in a 20 x 20-m cell and aggregation of host/non-host classified trees as fraction of hosts in a 20 x 20-m cell.
In our case, the 20 x 20-m aggregation produces a grid cell with an area of 400m\textsuperscript{2}, which most closely matches the 404m\textsuperscript{2} area of the ground-based vegetation plots whose data we used in an aggregated form to calibrate our derivation of Level 3 products.
<!-- \par \end{flushleft} -->

### Level 0: Raw data from sensors

Raw data comprised approximately 1900 images per camera lens (one broad-band RGB lens and five narrow-band multispectral lenses) for each of the 32 sites (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 0).
Prior to the aerial survey, two strips of bright orange drop cloth (~100 cm x 15 cm) were positioned as an "X" over the permanent monuments marking the center of the 5 field plots from @fettig2019 (see Supplemental Figures).

We preprogrammed north-south aerial transects using Map Pilot for DJI on iOS flight software [@dronesmadeeasy2018] at an altitude of 120 m above ground level (with "ground" defined using a 1-arc-second digital elevation model [@farr2007]).
The resulting ground sampling distance was approximately 5 cm/px for the Zenmuse X3 RGB camera and approximately 8 cm/px for the Rededge3 multispectral camera.
We used 91.6% image overlap (both forward and side) at the ground for the Zenmuse X3 RGB camera and 83.9% overlap (forward and side) for the Rededge3 multispectral camera.

### Level 1: Basic outputs from photogrammetric processing

We used structure from motion (SfM) photogrammetry implemented in Pix4Dmapper Cloud (www.pix4d.com) to generate dense point clouds (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 1, left), orthophotos (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 1, center), and digital surface models (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 1, right) for each field site [@frey2018].
For 29 sites, we processed the Rededge3 multispectral imagery alone to generate these products.
For three sites, we processed the RGB and the multispectral imagery together to enhance the point density of the dense point cloud.
All SfM projects resulted in a single processing "block," indicating that all images in the project were optimized and processed together.
The dense point cloud represents x, y, and z coordinates as well as the color of millions of points per site.
The orthophoto represents a radiometrically uncalibrated, top-down view of the survey site that preserves the relative x/y positions of objects in the scene.
The digital surface model is a rasterized version of the dense point cloud that shows the altitude above sea level for each pixel in the scene at the ground sampling distance of the camera that generated the Level 0 data.

### Level 2: Corrected outputs from photogrammetric processing

#### Radiometric corrections

A radiometrically-corrected reflectance map (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 2, left two figures; i.e., a corrected version of the Level 1 orthophoto) was generated using the Pix4D software by incorporating incoming light conditions for each narrow band of the Rededge3 camera (captured simultaneously with the Rededge3 camera using an integrated downwelling light sensor) as well as a pre-flight image of a calibration panel of known reflectance (see Supplemental Methods for camera and calibration panel details).

#### Geometric corrections

We implemented a geometric correction to the Level 1 dense point cloud and digital surface model by normalizing these data for the terrain underneath the vegetation. 
We generated the digital terrain model representing the ground underneath the vegetation at 1 meter resolution (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 2, third image) by classifying each survey area's dense point cloud into "ground" and "non-ground" points using a cloth simulation filter algorithm [@zhang2016] implemented in the `lidR` [@roussel2019] package and rasterizing the ground points using the `raster` package [@hijmans2019].
We generated a canopy height model (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 2, fourth image) by subtracting the digital terrain model from the digital surface model.

### Level 3: Domain-specific information extraction

#### Level 3a: Data derived from spectral OR geometric Level 2 product

Using just the spectral information from the radiometrically-corrected reflectance maps, we calculated several vegetation indices including the normalized difference vegetation index (NDVI; @rouse1973; `r fig_nums("fig-drone-data-levels", display = "cite")`; Level 3a, first image), the normalized difference red edge (NDRE; @gitelson1994), the red-green index (RGI; @coops2006), the red edge chlorophyll index (CI~red~ ~edge~; @clevers2013), and the green chlorophyll index (CI~green~; @clevers2013).

```{r}
table_nums(name = "table-algorithm-deets", "Algorithm name, number of parameter sets tested for each algorithm, and references.")
```


```{r algorithm_summary_print, echo = FALSE, include = TRUE, results = 'asis'}
algorithm_summary_print <-
  algorithm_summary %>% 
  dplyr::rename(`Parameter sets\ntested` = n,
                Algorithm = algorithm) %>%
  dplyr::mutate(`Reference(s)` = c("@li2012; @jakubowski2013; @shin2018", "@roussel2019a", "@roussel2019", "@eysn2015", "@vega2014", "@plowright2018", "@pau2010"))

pandoc.table(algorithm_summary_print, 
             split.tables = Inf,
             caption = table_nums(name = "table-algorithm-deets"),
             keep.line.breaks = TRUE)
```

Using just the geometric information from the canopy height model or terrain-normalized dense point cloud, we generated maps of detected trees (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 3a, second and third images) by testing a total of `r nrow(algorithm_summary)` automatic tree detection algorithms and a total of `r sum(algorithm_summary$n)` parameter sets (`r table_nums(name = "table-algorithm-deets", display = "cite")`).
We converted the height of each tree determined using the Level 2 canopy height model to its diameter at breast height, 1.37m (DBH).
We used the field plot data to assess each tree detection algorithm/parameter set by converting the distance-from-center and azimuth measurements of the trees in the field plots to x-y positions relative to the field plot centers distinguishable in the Level 2 reflectance maps as the orange fabric X's that we laid out prior to each flight.
In the reflectance maps, we located 110 out of 160 field plot centers while some plot centers were obscured due to dense interlocking tree crowns or because a plot center was located directly under a single tree crown.
For each of the 110 field plots with identifiable plot centers-- the "validation field plots", we calculated 7 forest structure metrics using the ground data collected by @fettig2019: total number of trees, number of trees greater than 15 meters, mean height of trees, 25^th^ percentile tree height, 75^th^ percentile tree height, mean distance to nearest tree neighbor, and mean distance to second nearest neighbor.
For each tree detection algorithm and parameter set described above, we calculated the same set of 7 structure metrics within the footprint of the validation field plots.
We calculated the Pearson's correlation and root mean square error (RMSE) between the ground data and the aerial data for each of the 7 structure metrics for each of the `r sum(algorithm_summary$n)` automatic tree detection algorithms/parameter sets.
For each algorithm and parameter set, we calculated its performance relative to other algorithms as whether its Pearson's correlation was within 5% of the highest Pearson's correlation as well as whether its RMSE was within 5% of the lowest RMSE.
We summed the number of forest structure metrics for which it reached these 5% thresholds for each algorithm/parameter set.
For automatically detecting trees across the whole study, we selected the algorithm/parameter set that performed well across the most number of forest metrics (see Results).

We delineated individual tree crowns (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 3a, fourth image) with a marker controlled watershed segmentation algorithm [@meyer1990] implemented in the `ForestTools` package [@plowright2018] using the detected treetops as markers.
If the automatic segmentation algorithm failed to generate a crown segment for a detected tree (e.g., often snags with a very small crown footprint), a circular crown was generated with a radius of 0.5 meters.
If the segmentation generated multiple polygons for a single detected tree, only the polygon containing the detected tree was retained.
Because image overlap decreases near the edges of the overall flight path and reduces the quality of the SfM processing in those areas, we excluded segmented crowns within 35 m of the edge of the survey area.
Given the narrower field of view of the Rededge3 multispectral camera versus the X3 RGB camera whose optical parameters were used to define the ~40 hectare survey area around each site, as well as the 35 m additional buffering, the survey area at each site was ~30 ha (see Supplemental Methods).

#### Level 3b: Data derived from spectral AND geometric information

We overlaid the segmented crowns on the reflectance maps from `r length(unique(hand_classified_crowns$site))` sites spanning the latitudinal and elevation gradient in the study.
Using QGIS (https://qgis.org/en/site/), we hand classified `r nrow(hand_classified_crowns)` trees as live/dead (`r fig_nums(name = "fig-live-dead-classification", display = "cite")`) and as one of 5 dominant species in the study area (*Pinus ponderosa*, *Pinus lambertiana*, *Abies concolor*, *Calocedrus decurrens*, or *Quercus kelloggi*) using the mapped ground data as a guide.
Each tree was further classified as "host" for ponderosa pine or "non-host" for all other species [@fettig2016].
We extracted all the pixel values within each segmented crown polygon from the five, Level 2 orthorectified reflectance maps (one per narrow band on the Rededge3 camera) as well as from the five, Level 3a vegetation index maps using the `velox` package [@hunziker2017].
For each crown polygon, we calculated the mean value of the extracted Level 2 and Level 3a pixels and used them as ten independent variables in a five-fold cross validated boosted logistic regression model to predict whether the hand classified trees were alive or dead.
For just the living trees, we similarly used all 10 mean reflectance values per crown polygon to predict tree species using a five-fold cross validated regularized discriminant analysis.
The boosted logistic regression and regularized discriminant analysis were implemented using the `caret` package in R [@kuhn2008].
Finally, we used these models to classify all tree crowns in the data set as alive or dead (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 3b, first image) as well as the species of living trees (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 3b, second image).

Using the tree height and DBH field data from @fettig2019, we fit a simple linear regression to predict DBH from height for each of the five dominant species in the study area.
We used these species-specific allometric relationships between field-measured tree height and DBH to estimate the DBH of each model-classified tree given its species and height.

### Level 4: Aggregations to regular grids

We rasterized the forest structure and composition data at a spatial resolution similar to that of the field plots to better match the grain size at which we validated the automatic tree detection algorithms.
In each raster cell, we calculated: number of live trees, number of dead trees, number of ponderosa pine trees, total number of trees (of all species, including ponderosa pine).
From these values, we calculated the fraction of dead trees per cell (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 4, first image) and the fraction of host trees per cell (`r fig_nums("fig-drone-data-levels", display = "cite")`; Level 4, second image).
We converted the count of ponderosa pine trees and the total tree count to a density measurement of trees per hectare (tpha) by multiplying the counts in each 20 x 20-m cell by `r 10000/400` to create a "host density" and an "overall density" variable per cell.
Finally, we then calculated a separate quadratic mean diameter (QMD) for ponderosa pine and all trees of any species for each 20 x 20-m cell as the square root of the average squared diameter of trees (ponderosa or all) within the cell.

### Note on assumptions about dead trees

For the purposes of this study, we assumed that all dead trees were ponderosa pine and thus hosts colonized by WPB.
This is a reasonably good assumption for our study area; for example, @fettig2019 found that `r pipo_pct_of_all_dead`% of dead trees in their coincident field plots were ponderosa pine.
Mortality was concentrated in the larger-diameter classes and attributed primarily to WPB (see @fettig2019, Figure 5).
The species contributing to the next highest proportion of dead trees was incense cedar which represented `r cade_pct_of_all_dead`% of the dead trees in the field plots.
While the detected mortality is most liklye to be ponderosa pine, it is critical to interpret our results with this known limitation in mind.

### Environmental data

We used climatic water deficit (CWD) [@stephenson1998] from the 1981-2010 mean value of the basin characterization model [@flint2013] as an integrated measure of temperature and moisture conditions for each of the 32 sites.
Higher values of CWD correspond to hotter, drier conditions and lower values correspond to cooler, wetter conditions.
CWD has been shown to correlate well with broad patterns of tree mortality in the Sierra Nevada [@young2017] as well as bark beetle-induced tree mortality [@millar2012].
We converted the CWD value for each site into a z-score representing that site's deviation from the mean CWD across the climatic range of Sierra Nevada ponderosa pine as determined from 179 herbarium records described in @baldwin2017a.
Thus, a CWD z-score of 1 would indicate that the CWD at that site is one standard deviation hotter/drier than the mean CWD across all geolocated herbarium records for ponderosa pine in the Sierra Nevada.

### Statistical model

We used a generalized linear model with a zero-inflated binomial response and a logit link to predict the probability of ponderosa pine mortality within each 20 x 20-m cell as a function of the crossed effects of ponderosa pine QMD and density added to the crossed effect of QMD and density of trees of all species in each cell (hereafter "overall QMD" and "overall density"), as well as the interaction of each summand with climatic water deficit at each site.

To measure and account for spatial autocorrelation of the bark beetle behavioral processes underlying ponderosa pine mortality, we subsampled the data at each site to a random selection of 200, 20 x 20-m cells representing approximately 27.5% of the surveyed area.
Additionally with these subsampled data, we included a separate exact Gaussian process term per site of the interaction between the x- and y-position of each cell using the `gp()` function in the `brms` package [@burkner2017].
The Gaussian process estimates the spatial covariance in the response variable (log-odds of ponderosa pine mortality) jointly with the effects of the other covariates.

$$
\begin{aligned}
y_{i,j} \sim &\ \begin{cases}
0, & p \\
Binom(n_i, \pi_i), & 1-p
\end{cases} \\
logit(\pi_i) = &\ \beta_0\ + \\
& \beta_1X_{cwd, j}\ + \\
& \beta_1X_{cwd, j}(\beta_2X_{pipoQMD, i} + \beta_3X_{pipoDensity, i} + \beta_4X_{pipoQMD, i}X_{pipoDensity, i})\ + \\ 
& \beta_1X_{cwd, j}(\beta_5X_{overallQMD, i} + \beta_6X_{overallDensity, i} + \beta_7X_{overallQMD, i}X_{overallDensity, i})\ + \\
& \mathcal{GP}_j(x_i, y_i) \\
\end{aligned}
$$

Where $y_i$ is the number of dead trees in cell $i$, $n_i$ is the sum of the dead trees (assumed to be ponderosa pine) and live ponderosa pine trees in cell $i$, $\pi_i$ is the probability of ponderosa pine tree mortality in cell $i$, $p$ is the probability of there being zero dead trees in a cell arising as a result of an unmodeled process, $X_{cwd, j}$ is the z-score of climatic water deficit for site $j$, $X_{pipoQMD, i}$ is the scaled quadratic mean diameter of ponderosa pine in cell $i$, $X_{pipoDensity, i}$ is the scaled density of ponderosa pine trees in cell $i$, $X_{overallQMD, i}$ is the scaled quadratic mean diameter of all trees in cell $i$, $X_{overallDensity, i}$ is the scaled density of all trees in cell $i$, $x_i$ and $y_i$ are the x- and y- coordinates of the centroid of the cell in an EPSG3310 coordinate reference system, and $\mathcal{GP}_j$ represents the exact Gaussian process describing the spatial covariance between cells at site $j$.

We used 4 chains with 2000 iterations each (1000 warmup, 1000 samples), and confirmed chain convergence by ensuring all `Rhat` values were less than 1.1 [@brooks1998].
We used posterior predictive checks to visually confirm model performance by overlaying the density curves of the predicted number of dead trees per cell over the observed number [@gabry2019].
For the posterior predictive checks, we used 50 random samples from the model fit to generate 50 density curves and ensured curves were centered on the observed distribution, paying special attention to model performance at capturing counts of zero.

### Software and data availability

All data are available via the Open Science Framework.
Statistical analyses were performed using the `brms` packages.
With the exception of the SfM software (Pix4Dmapper Cloud) and the GIS software QGIS, all data carpentry and analyses were performed using `R` [@rcoreteam2018].

## Results

### Tree detection algorithm performance

We found that the experimental `lmfx` algorithm with parameter values of `dist2d = `r algorithm_details[1, "var1_val"]`` and `ws = `r algorithm_details[1, "var2_val"]`` [@roussel2019] performed the best across 7 measures of forest structure as measured by Pearson's correlation with ground data (`r table_nums(name = "table-best-algorithm-deets", display = "cite")`). 

```{r}
table_nums(name = "table-best-algorithm-deets", paste0("Correlation and differences between the best performing tree detection algorithm (lmfx with dist2d = ", algorithm_details[1, "var1_val"], " and ws = ", algorithm_details[1, "var2_val"], ") and the ground data.
An asterisk next to the correlation or RMSE indicates that this value was within 5% of the value of the best-performing algorithm/parameter set.
Ground mean represents the mean value of the forest metric across the 110 field plots that were visible from the sUAS-derived imagery.
The median error is calculated as the median of the differences between the air and ground values for the 110 visible plots.
Thus, a positive number indicates an overestimate by the sUAS workflow and a negative number indicates an underestimate."))
```

```{r best_algorithm_deets_table, echo = FALSE, include = TRUE, results = 'asis'}
best_algorithm_deets_print <-
  best_algorithm_deets %>% 
  ungroup() %>% 
  dplyr::select(forest_metric, ground_correlation, rmse, me, med_error, ground_cor_within_threshold_pct, rmse_within_threshold_pct) %>% 
  dplyr::mutate(ground_correlation = ifelse(ground_cor_within_threshold_pct == 1, yes = paste0(as.character(sprintf("%0.2f", ground_correlation)), "*"), no = as.character(sprintf("%0.2f", ground_correlation)))) %>% 
  dplyr::mutate(rmse = ifelse(rmse_within_threshold_pct == 1, yes = paste0(as.character(sprintf("%0.2f", rmse)), "*"), no = as.character(sprintf("%0.2f", rmse)))) %>% 
  dplyr::select(forest_metric, ground_correlation, rmse, me, med_error) %>% 
  dplyr::mutate(forest_metric = c("height (m); 25th percentile",
                                  "height (m); mean",
                                  "height (m); 75th percentile",
                                  "distance to 1st neighbor (m)",
                                  "distance to 2nd neighbor (m)",
                                  "distance to 3rd neighbor (m)",
                                  "total tree count",
                                  "count of trees > 15m",
                                  "count of trees < 15m")) %>% 
  dplyr::rename(`Forest structure metric` = forest_metric,
                `Correlation with ground` = ground_correlation,
                RMSE = rmse,
                `Mean error` = me,
                `Median error` = med_error) %>% 
  dplyr::mutate(sort = c(7:9, 4:6, 1:3)) %>% 
  dplyr::arrange(sort) %>% 
  dplyr::mutate(`Ground mean` = t(ground_tree_summary_print)[, 1]) %>% 
  dplyr::select(`Forest structure metric`,
                `Ground mean`,
                `Correlation with ground`,
                RMSE,
                `Median error`) %>% 
  dplyr::filter(`Forest structure metric` %in% 
                  c("height (m); 25th percentile",
                    "height (m); mean",
                    "height (m); 75th percentile",
                    "distance to 1st neighbor (m)",
                    "distance to 2nd neighbor (m)",
                     "total tree count",
                    "count of trees > 15m"))

pandoc.table(best_algorithm_deets_print, 
             digits = 2, 
             split.tables = Inf,
             caption = table_nums(name = "table-best-algorithm-deets"),
             keep.line.breaks = TRUE)
```

### Classification accuracy for live/dead and host/non-host

The accuracy of live/dead classification on a withheld test dataset was `r round(classifier_stats[classifier_stats$type == "live/dead", "accuracy"] %>% pull() * 100, 1)`%.
The accuracy of species classification on a withheld testing dataset was `r round(classifier_stats[classifier_stats$type == "species", "accuracy"] %>% pull() * 100, 1)`%.
The accuracy of WPB host/non-WPB-host (i.e., ponderosa pine versus other tree species) on a withheld testing dataset was `r round(classifier_stats[classifier_stats$type == "host/non-host", "accuracy"] %>% pull() * 100, 1)`%.

### Site summary based on best tree detection algorithm and classification

Across our study site, we detected, segmented, and classified `r site_characteristics %>% mutate(ntrees = air_tpha * buffered_survey_area) %>% summarize(ntrees = sum(ntrees)) %>% pull(ntrees) %>% formatC(format="f", big.mark=",", digits=0)` trees (see Supplemental Table for site summarys). Estimated tree mortality at a site ranged from `r site_characteristics %>% summarize(minMortality = min(prop_mortality)) %>% pull(minMortality) %>% round(3) * 100`% to `r site_characteristics %>% summarize(maxMortality = max(prop_mortality)) %>% pull(maxMortality) %>% round(3) * 100`%.

### Effect of local structure and regional climate on tree mortality attributed to western pine beetle

```{r}
fig_nums(name = "fig-halfeye", "Posterior distributions of effect size from zero-inflated binomial model predicting the probability of ponderosa pine mortality in a 20 x 20-m cell given forest structure characteristics of host trees and all trees within the cell, as well as a site-level climatic water deficit.
The gray density distribution for each model covariate represents the density of the posterior distribution, the point underneath each density curve represents the median of the estimate, the bold interval surrounding the point estimate represents the 66% credible interval, and the thin interval surrounding the point estimate represents the 95% credible interval.")
```

![`r fig_nums(name = "fig-halfeye")`](../../figures/effect-sizes-halfeye.png)

We detected a small, generally positive main effect of climatic water deficit on the probability of ponderosa pine mortality within each 20 x 20-m cell (`r fig_nums(name = "fig-halfeye", display = "cite")`).

We found a strongly positive main effect of ponderosa pine local density, with greater density increasing the probability of ponderosa pine mortality.
Conversely, we found a strong negative effect of overall tree density (i.e., including both ponderosa pine and non-host species) such that additional non-host trees in a 20 x 20-m cell (for the same number of host trees) would decrease the probability of ponderosa pine mortality (`r fig_nums(name = "fig-halfeye", display = "cite")`).

We found a generally negative effect of quadratic mean diameter (QMD) of ponderosa pine on the probability of ponderosa mortality, suggesting that the western pine beetle attacked smaller trees, on average.
There was a strong positive interaction between the climatic water deficit and ponderosa pine QMD, such that larger trees were more likely to increase the probability of ponderosa mortality in hotter, drier sites (`r fig_nums(name = "fig-three-way-interaction", display = "cite")`).

There was a positive interaction between overall tree density and overall QMD, such that denser stands with larger trees led to greater ponderosa pine mortality, though the main effects of each of these variables were weakly negative (`r fig_nums(name = "fig-halfeye", display = "cite")`).


```{r}
fig_nums(name = "fig-three-way-interaction", "Line version of model results with 95% credible intervals showing primary influence of ponderosa pine structure on the probability of ponderosa pine mortality, and the interaction across climatic water deficit.
The 'larger trees' line represents the quadratic mean diameter of ponderosa pine 0.7 standard deviations above the mean, and the 'smaller trees' line represents the quadratic mean diameter of ponderosa pine 0.7 standard deviations below the mean.")
```

![`r fig_nums(name = "fig-three-way-interaction")`](../../figures/pipo_tpha_qmd_cwd_interaction.png)


is a dominant driver of host mortality during elevated levels of bark beetle activity, likely due to energy costs associated with beetles navigating forests with many non-hosts available.

We also found that, even within a single forest insect/tree species pairing, in the same extreme drought, and conditional upon high levels of western pine beetle activity, host tree size may still strongly affect insect-induced tree mortality in different ways depending on background environmental conditions of water stress.

We suggest that this may indicate different stages of bark beetle disturbance throughout the Sierra yellow pine/mixed-conifer system, with "outbreak" thresholds surpassed at the hottest, driest sites where larger trees led to more likely host mortality, but not yet surpassed in cooler, wetter sites, where smaller trees led to more likely host mortality.


## Discussion

This study represents the first attempt to use drones to further our understanding of the simultaneous effects of local forest structure and composition with broad-scale environmental gradients on tree mortality attributed to WPB. 
We found strong positive effects of both host tree density and the interaction between site climatic water deficit (CWD) and host tree mean size (QMD) on the probability of ponderosa pine mortality. 
Conversely, we found a strong negative effect of overall tree density (`r fig_nums("fig-halfeye", display = "cite")`). 
Surprisingly, site CWD exerted only a weakly positive main effect on the probability of ponderosa mortality.
To that end, we did not measure tree water stress at an individual tree level as in other recent work [@stephenson2019], and instead treated CWD as a general indicator of tree stress following results of coarser-scale studies [@asner2016; @young2017]. 
This may have contributed to our failure to detect a stronger CWD effect.
Also, our entire study area experienced the same extreme hot drought between 2012 and 2015 and the variation of mortality explained by a main effect of climatic water deficit may be dampened when most trees are experiencing a high degree of water stress [@floyd2009; @fettig2019].

The strongest effect on the probability of ponderosa pine mortality was the local host density within each 20 x 20-m cell.
Host availability has been shown to have a strong influence on the prevalence of host mortality [@raffa1987].
This can arise as beetles require shorter flights to disperse to new hosts and beetles are less likely to land on a non-host tree which imposes a "sunk cost" of energy expenditure in getting to that tree.
Reduced dispersal distances to host trees likely favors successful bark beetle attacks, but we calibrated our aerial tree detection to ~400 m^2^ areas rather than to individual tree locations so don't have the data precision to address this hypothesis directly.
Because we also found a strong negative effect of overall tree density (host plus non-host) within each cell while accounting for host density, we suspect that the positive association between host density and host mortality might be driven by increasing the frequency that western pine beetles land on their preferred host and avoid expending energy flying to non-hosts.
The negative relationship that we detected between overall tree density and host mortality corroborates findings from @fettig2019 and perhaps the "sunk cost" of landing on non-hosts explains those findings, though @fettig2019 didn't simultaneously model the effect of host density.
In general, @hayes2009 and @fettig2019 found that measures of host availability explained less variation in mortality than measures of overall tree density, but those conclusions were based on a response variable of "total number of dead host trees," rather than the number of dead host trees conditional on the total number of host trees as in our study (i.e., a binomial response).

Counter to our expectations, we found an overall negative effect of host tree mean size on the probability of host mortality.
Generally, smaller trees are easier for western pine beetles to overwhelm in a mass attack and are prime targets under normal levels of tree water stress.
However, larger trees are more nutritious and are therefore ideal targets if local bark beetle density is high enough to successfully initiate mass attack as can occur when many trees are under severe water stress [@bentz2010].
In the recent hot drought, we expected that most trees would be under severe water stress, setting the stage for increasing beetle density, successful mass attacks, and targeting of larger trees.
Larger average tree size in this case would therefore lead to greater ponderosa pine mortality, as was found in coincident field plots [@fettig2019] and other studies [@pile2019; @stephenson2019].
One possible explanation for our finding is that our observations represent the cumulative mortality of trees during a multi-year drought event and its aftermath.
Lower host tree mean size led to a greater probability of host mortality earlier in the drought [@pile2019] and that signal might have persisted even as mortality continued to accumulate driven by other factors.

We did find a clear host tree size effect in its interaction with the climatic water deficit.
In hot, dry sites, larger average host size increased the probability of host mortality while smaller host sizes increased the probability of host mortality in cool, wet sites.
This suggests that the same bark beetle species was cueing into different aspects of forest structure across the environmental gradient.
This represents an intraspecific version of the results of @stephenson2019, who found that insect-induced tree mortality in the same region during the same hot drought were driven by different factors for different tree species.
For instance, @stephenson2019 found that ponderosa pine mortality was largely driven by host selection behavior of forest insects, where larger more nutritious trees were specifically targeted regardless of whether they exhibited signs of stress.
In contrast, @stephenson2019 found that white fir mortality occurred predominantly in the slower growing, smaller, stressed trees.
In our study, we found that, even within a single pairing of forest insect species and its host, the host tree size affected host mortality differently depending on the site-level climatic water deficit.

For primary bark beetles, massive tree mortality as observed from the 2012-2015 drought and its aftermath does not necessarily distinguish "endemic" from "outbreak" phases of bark beetle disturbance, which is instead distinguished by the underlying driver of bark beetle host selection behavior [@logan1998].
"Endemic" phases are distinguished by environmental determinism, when beetles select hosts based on whether they are weakened in some way, often by environmental conditions.
"Outbreak" phases are distinguished by dynamic determinism, when population dynamics reign-- when local beetle density is high enough that intraspecific pheromone communication dominates host selection, successful mass attacks are likely, and even large healthy trees can be killed [@white1997; @logan1998].
Despite high local levels of tree mortality across our study area [@fettig2019], our results from surveying the broader context surrounding coincident field plots reveals different effects of host tree size depending on the climatic water deficit, and perhaps different stages of bark beetle disturbance across the environmental gradient.
This may help explain the especially high host mortality in high host density, low host size cells that we observed in cool/wet sites (`r fig_nums(name = "fig-three-way-interaction", display = "cite")`).
The smaller trees would presumably be nutritionally sub-optimal, and thus unexpected targets if the western pine beetle were indeed in an "outbreak" phase at these sites and able to attack even large, healthy trees.
While trees were likely water stressed across the whole study due to the extreme drought, we expected generally less water stress in the cool/wet sites, and generally higher water stress in the hot/dry sites [@asner2016; @young2017].
Thus, it is possible that the observed mortality patterns across the Sierra Nevada during the 2012-2015 hot drought arose as synergistic alignment of environmental conditions and complex forest structure enabled the western pine beetle to cross thresholds of "outbreak" behavior in the hottest, driest sites but such an alignment was not present in the cooler, wetter sites [@raffa2008].

## Limitations and future directions

We have demonstrated that drones can be effective means of collecting forest data at multiple, vastly different spatial scales to investigate a single, multi-scale phenomenon-- from meters in between trees, to hundreds of meters of elevation, to hundreds of thousands of meters of latitude.
Some limitations remain but can be overcome with further refinements in the use of this tool for forest ecology.
Most of these limitations arise from tree detection and classification uncertainty, and thus it was imperative to work with field data for calibration and uncertainty reporting.
These limitations also imply that a conifer forest system with less bark beetle and tree host diversity, such as mountain pine beetle-induced mortality in monocultures of lodgepole pine, should be particularly amenable to the methods presented here even with minimal further refinement.

The greatest limitation in our study arising from classification uncertainty is in the assumption that all dead trees were ponderosa pine.
We estimate from coincident field plots that this is true approximately `r pipo_pct_of_all_dead`% of the time.
Because tree mortality response to forest insects is species-specific, even with sympatric tree species during the same hot drought [@stephenson2019], we cannot entirely rule out that some of the mortality responses to complex forest structure that we observed arose from these species-specific responses.
The overall community composition across our study area was not very different [@fettig2019], so we remain confident that the patterns we observed were driven primarily by the dynamic between the western pine beetle and ponderosa pine.

Our ability to detect trees using the geometry of the dense point clouds derived with the SfM was also limited.
The horizontal accuracy of the tree detection was better than the vertical accuracy, which may result from a more significant error contribution by the ground-based calculations of tree height compared to tree position relative to plot center (`r table_nums(name = "table-best-algorithm-deets", display = "cite")`).
Both the horizontal and vertical accuracy would likely improve with better SfM point clouds, which requires imagery with more overlap.
@frey2018 recently found that 95% overlap was preferable for generating dense point clouds, and we only achieved 91.6% overlap with the X3 RGB camera and 83.9% overlap with the multispectral camera.
While our live/dead classification was fairly accurate (`r round(classifier_stats[classifier_stats$type == "live/dead", "accuracy"] %>% pull() * 100, 1)`% on a withheld dataset), our species classifier would likely benefit from better crown segmentation because the pixel-level reflectance values within each crown are averaged to characterize the "spectral signature" of each tree.
With better delineation of each tree crown, the mean value of pixels within each tree crown will likely be more representative of that tree's spectral signature.
Better crown segmentation would most readily be achieved through greater overlap in imagery.
Finally, we anticipate that computer vision and deep learning will prove helpful in overcoming some of these detection and classification challenges [@gray2019].

## Conclusions

Climate change adaptation strategies emphasize reducing tree densities to restore forest resilience [@north2015; @young2017], but understanding the optimal complex forest structure that can enable dry western U.S. forests to persist through disturbances such as insect attack will be vital for predicting how California forests may respond to these interventions.
We've shown that drones can be a valuable tool for investigating how this complexity in forest structure combines with environmental conditions to shape forest insect disturbance.

Our results support conclusions of other researchers that management interventions to reduce the severity of bark beetle disturbance will benefit from generally reducing host density [@young2017].
In addition however, our study suggests that outcomes will depend on whether the disturbance dynamic has crossed endemic to outbreak feedback thresholds [@raffa2008], which may be predicted by recent advances in disturbance forecasting [@preisler2017].

## Acknowledgements

We gratefully acknowledge funding from the USDA Forest Service Western Wildlands Environmental Threat Assessment Center (WWETAC) and the Pacific Southwest Research Station Climate Change Competitive Grant Program. We thank Connie Millar for comments and guidance during the development of this project and Victoria Scholl for helpful discussions regarding remotely sensed data product levels.

## References