---
bibliography: ../docs_carpentry/local-structure-wpb-severity.bib
csl: ../docs_carpentry/ecological-applications.csl
params:
  title: Complex forest structure interacts with climatic water deficit to drive forest insect disturbance severity in a recent hot drought
  author: |
    Michael J. Koontz^1,2,\*^,
    Andrew M. Latimer^1,2^,
    Leif A. Mortenson^3^,
    Christopher J. Fettig^3^,
    Malcolm P. North^1,2,4^
  affiliation: |
    ^1^Graduate Group in Ecology, University of California, Davis, CA, USA  
    ^2^Department of Plant Sciences, University of California, Davis, CA, USA  
    ^3^USDA Forest Service, Pacific Southwest Research Station, Placerville, CA, USA  
    ^4^USDA Forest Service, Pacific Southwest Research Station, Davis, CA, USA
  correspondence: |
    michael.koontz@colorado.edu
  date_generated: !r format(Sys.Date(), "%B %d, %Y")
  
geometry: margin=1in
header-includes:
  - \usepackage[left]{lineno}
  - \linenumbers
  - \usepackage{setspace}
  - \doublespacing
  - \DeclareUnicodeCharacter{200E}{}
  - \usepackage{caption}
  - \captionsetup[figure]{labelformat=empty}
  - \captionsetup[table]{labelformat=empty}

output: pdf_document
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

```{r libraries}
library(tidyverse)
library(pander)
library(captioner)
```

```{r captions}
fig_nums <- captioner(prefix = "Figure")
table_nums <- captioner(prefix = "Table")
eq_nums <- captioner(prefix = "Equation")
```

```{r source_necessary_scripts}
source(here::here("analyses/evaluate-ground-correspondence-ttops.R"))
# Object to get information about extent of algorithm/paramter set coverage
# is called `algorithm_summary`
source(here::here("data/data_carpentry/format-ground-data.R"))
# Object with ground data is called `d`
```

```{r ground_data_deets}
pipo_pct_of_all_dead <-
  d %>%
  dplyr::filter(is.na(year_fall), !is.na(year_dead)) %>%
  group_by(species) %>%
  summarize(n = n(),
            prop_of_all_dead = n() / nrow(.),
            print_prop = round(prop_of_all_dead * 100, digits = 2)) %>%
  dplyr::filter(species == "PIPO") %>%
  pull(print_prop)

cade_pct_of_all_dead <-
  d %>%
  dplyr::filter(is.na(year_fall), !is.na(year_dead)) %>%
  group_by(species) %>%
  summarize(n = n(),
            prop_of_all_dead = n() / nrow(.),
            print_prop = round(prop_of_all_dead * 100, digits = 2)) %>%
  dplyr::filter(species == "CADE") %>%
  pull(print_prop)
```

```{r ground_tree_summary}
ground_tree_summary <- readr::read_csv(here::here("analyses/analyses_output/ground-tree-summary.csv"))

ground_tree_summary_print <-
  ground_tree_summary %>% 
  summarize(mean_total_count = mean(total_tree_count),
            mean_short_count = mean(tree_count_below_15m),
            mean_tall_count = mean(tree_count_above_15m),
            mean_nn1 = mean(nn_1_mean),
            mean_nn2 = mean(nn_2_mean),
            mean_nn3 = mean(nn_3_mean),
            mean_short_height = mean(height_lwr_25),
            mean_height = mean(height_mean),
            mean_tall_height = mean(height_upr_25))

```


```{r classifier_stats}
classifier_stats <- read_csv(here::here("analyses/analyses_output/classification-summary-stats.csv"))
```

```{r hand_classified_crowns}
hand_classified_crowns <- read_csv(here::here("data/data_output/classified/hand-classified/hand-classified-crowns.csv")) %>% 
  dplyr::mutate(site = substr(treeID, start = 1, stop = 9))
```

```{r feet_to_meters}
# 3000 = 914.4
# 4000 = 1219.2
# 5000 = 1524
# 6000 = 1828
# 7000 = 2133.6
```

#`r params$title`

`r params$author`

`r params$affiliation`

^\*^Correspondence: ``r params$correspondence``

Date report generated: `r params$date_generated`

## Abstract 

The recent Californian hot drought of 2012 to 2015 created favorable conditions for unprecedented ponderosa pine mortality in the driest, densest portions of the Sierra Nevada mountain range, largely caused by the western pine beetle (*Dendroctonus brevicomis*). Climate conditions related to tree water stress as well as forest structure can both influence the severity of forest insect disturbance, but it remains challenging to consider how these variables may interact to produce patterns of tree mortality. Previous studies have shown an interaction between climate conditions and forest density in their effect on tree mortality, but forest density is a coarse gauge of forest structure that can affect western pine beetle behavior in a number of ways. Measuring broad-scale climate conditions simultaneously with complex forest structure-- including tree species, tree size, and local density-- will refine our understanding of how these variables interact, but is generally expensive and/or labor-intensive. We overcame these hurdles by using a small, unhumanned aerial system to conduct aerial surveys over an established network of 32 forest plots along a 350km and 1000m elevation gradient in western slope Sierra yellow pine/mixed-conifer forests. Using Structure from Motion (SfM) processing on over 450,000 images and field measurements from the coincident ground plots, we determined tree size, location, and species for individual trees over 9 square kilometers of forest that experienced ponderosa pine mortality as a result of western pine beetle activity. We modeled the probability of ponderosa pine mortality as a linear combination of forest structure variables and site-level climatic water deficit, and used a Gaussian process to estimate the spatial covariance in the response. 

We found that greater host density strongly increased the probability of host mortality, and greater host size generally decreased the probability of host mortality. There was also a strong three-way interaction between host density, host size, and climatic water deficit such that host density and host size tended to synergistically increase the probability of host mortality at hot/dry sites, but denser, smaller trees tended to drive mortality in cool/wet sites.  

Our results demonstrate a variable response of the western pine beetle to complex forest structure across an environmental gradient during the same hot drought, which may indicate forest sites were in different stages of disturbance (from "endemic" to "outbreak") depending on their regional climate. Management interventions that reduce stem density may decrease the severity of western pine beetle disturbance in the future, and our results suggest that focusing these treatments on areas that are most likely to exceed feedback thresholds (i.e., hot/dry sites with many available hosts) will have the best chance of increasing the survivorship probability of larger trees.


## Introduction

Aggressive bark beetles dealt the final blow to many of the nearly 150 million trees killed in the California hot drought of 2012 to 2015 and its aftermath [@usdafs2019]. A harbinger of climate change effects to come, record high temperatures exacerbated the drought [@griffin2014], which increased water stress on trees [@asner2016], making them more susceptible to attacking bark beetles [@fettig2012b; @kolb2016]. A century of fire suppression policy has enabled forests to grow into dense stands, which also makes them more vulnerable to bark beetle attack [@fettig2012b]. This combination of environmental conditions and forest structural characteristics led to tree mortality events of unprecedented size in the driest, densest forests across the state [@young2017]. The mechanisms underlying the link between tree susceptibility to insect attack and hot, dry conditions are often directly attributed to tree physiology [@bentz2010], while the link to forest density is multifaceted [@fettig2012b]. Because forest density is a coarse metric of the complex forest structure to which bark beetles respond [@raffa2008], our understanding of the connection between forest density and insect disturbance severity may be enhanced with more finely-resolved measures of forest structure, such as tree size, tree species, and local density within a forest stand [@fettig2019; @stephenson2019]. Further, the interaction between local-scale complex forest structure and broad-scale environmental conditions as they affect forest insect disturbance remains underexplored [@seidl2016a; @stephenson2019; @fettig2019].

The yellow pine/mixed-conifer forests in Californiaâ€™s Sierra Nevada region are characterized by regular bark beetle disturbances, primarily by the western pine beetle (*Dentrodctonus brevicomis*) and its main host in the system, ponderosa pine (*Pinus ponderosa*) [@fettig2019]. The western pine beetle is a "primary" or "aggressive" bark beetle, with reproductive success contingent upon enough beetles "mass attacking" the host tree, overwhelming its defenses, and causing mortality [@raffa1983; @fettig2019]. This Allee effect creates a strong coupling between beetle host selection behavior and host tree susceptibility to attack [@raffa1983; @logan1998]. Under normal conditions, weakened trees are the most susceptible to attack and will be the main targets of aggressive bark beetles like the western pine beetle [@bentz2010; @raffa2015]. A key defense mechanism of trees to bark beetle attack is to flood beetle bore holes with resin, which physically expels beetles and may interrupt beetle communication [@raffa2015]. Under severe water stress, trees no longer have the resources available to mount this defense [@kolb2016] and thus prolonged drought can often trigger increased bark beetle-induced tree mortality as average tree vigor declines [@bentz2010]. As local beetle density increases due to successful reproduction on spatially aggregated weakened trees, as might occur in a prolonged drought, mass attacks become capable of overwhelming any tree's defenses and even healthy trees become susceptible [@bentz2010; @raffa2015]. Thus, water stress can be a key determinant of whether individual trees are susceptible to bark beetle attack under many conditions, and this environmental condition may interact with other forest features, such as tree size, to drive susceptibility under extreme conditions [@bentz2010; @stephenson2019].

Forest structure-- often characterized as the spatial distribution, size, and species composition of trees-- also strongly influences western pine beetle activity. For instance, high-density forests are more prone to bark beetle attacks, and several mechanism likely underlie this phenomenon [@fettig2012b]. A high-density forest may experience greater bark beetle-induced tree mortality because host availability is high and shorter dispersal distances facilitate successful colonization of those hosts [@miller1960; @berryman1982; @fettig2007], because high host availability reduces the chance of individual beetles wasting their limited resources flying to and landing on a non-host tree [@moeck1981; @evenden2014], because crowded trees experience greater competition for water resources and thus average tree resistance is lower [@hayes2009], or because smaller gaps between trees protect pheromone plumes from dissipation by the wind and thus enhance intraspecific beetle communication [@thistle2004]. Additionally, tree size affects bark beetle host selection behavior as smaller trees tend to have less capacity for resisting attack, but larger trees represent a more desirable target because their thicker phloem provides greater nutritional value [@chubaty2009; @graf2012]. Tree density thus paints a fundamentally limited picture of the mechanism by which forest structure affects bark beetle disturbance, but *complex* forest structure-- with explicit recognition of tree size, species composition (e.g., host versus non-host composition), and local tree density-- should more appropriately capture the ecological processes underlying insect-induced tree mortality. Additionally, considering the effects of complex forest structure simultaneously to the effects of environmental conditions may help refine our understanding of observed patterns of tree mortality in the recent California hot drought.

The vast spatial extent of tree mortality in the 2012 to 2015 California hot drought [@usdafs2019] challenges our ability to simultaneously consider how broad-scale environmental conditions may interact with local, complex forest structure to affect the dynamic between bark beetle host selection and host tree susceptibility to attack [@anderegg2015a; @stephenson2019]. Measuring complex forest structure generally requires expensive instrumentation [@kane2014; @asner2016] or labor-intensive field surveys [@larson2012; @stephenson2019], which constrains survey extent and frequency. Small, unhumanned aerial systems (sUAS) enable relatively fast and cheap remote imaging over dozens of hectares of forest, which can be used to measure complex forest structure at the individual tree scale [@morris2017; @shiklomanov2019]. Distributing such surveys across an environmental gradient is a viable approach to overcoming the data acquisition challenge inherent in investigating phenomena with both a strong local- and a strong broad-scale component.

We used ultra-high resolution remote sensing data from a small, unhumanned aerial system over a network of 32 sites in Sierra Nevada yellow pine/mixed-conifer forests spanning 1000m of elevation and 350km of latitude and covering a total of 9 square kilometers to ask how broad-scale environmental conditions interacted with local, complex forest structure to affect the probability of tree mortality during the cumulative tree mortality event of 2012 to 2018. We asked:

1. How does host tree density and average host tree size affect the severity of western pine beetle disturbance?

2. How does tree density of all species (hereafter "overall density") and average tree size of all species (hereafter "overall size") affect the severity of western pine beetle disturbance?

3. How does environmentally-driven tree moisture stress affect the severity of western pine beetle disturbance?

4. Do the effects of forest structure and environmental condition on western pine beetle disturbance interact?

## Methods

### Study system

```{r}
fig_nums(name = "fig-geographic-extent", "The network of field plots spanned a 350 km latitudinal gradient from the Eldorado National Forest in the north to the Sequoia National Forest in the south. Plots were stratified by three elevation bands in each forest, with the plots in the Sequoia National Forest (the southern-most National Forest) occupying elevation bands 305m above the three bands in the other National Forests in order to capture a similar community composition.")
```

![`r fig_nums("fig-geographic-extent")`](../../figures/study-geographic-extent-inset.png){ height=7in }

The study sites were chosen to reflect typical west-side Sierra Nevada yellow pine/mixed-conifer forests and were dominated by ponderosa pine trees, *Pinus ponderosa* [@fettig2019], whose primary bark beetle predator in California is the western pine beetle (WPB), *Dendroctonus brevicomis*. The typical life cycle of WPBs consists of pioneer beetles dispersing to a new host tree, determining the host's susceptibility to attack, and using pheromone signals to attract other WPBs. The attracted WPBs mass attack the tree by boring into its inner bark, laying eggs, and dying, leaving their offspring to develop inside the doomed tree before themselves dispersing to a new potential host [@raffa2008]. In California, the WPB can have 2-3 generations in a single year and can often out-compete its congener, the mountain pine beetle, *Dendroctonus ponderosa* (MPB), for the ponderosa pine host [@fettig2019].

We built our study on 180 vegetation/forest insect monitoring plots at 36 sites established between 2016 and 2017 by @fettig2019 (`r fig_nums(name = "fig-geographic-extent", display = "cite")`). These established plots were located in WPB-attacked, yellow pine/mixed-conifer forests across the Eldorado, Stanislaus, Sierra and Sequoia National Forests and were stratified by elevation (914-1219 meters [3000-4000 feet], 1219-1524 meters [4000-5000 feet], 1524-1828 meters [5000-6000 feet] above sea level). In the Sequoia National Forest, the southernmost National Forest in our study, plots were stratified with the lowest elevation band between 1219 and 1524 meters (4000-5000 feet) and extended to an upper elevation band of 1828-2133 meters (6000-7000 feet) to capture a more similar forest community composition as at the more northern National Forests. The sites have variable forest structure and plot locations were selected in areas with >40% ponderosa pine basal area and >10% ponderosa pine mortality. At each site, five 0.04 ha circular plots were installed along transects with between 80 and 200m between each plot. In the field, @fettig2019 mapped all stem locations relative to the center of each plot using azimuth/distance measurements. Tree identity to species, tree height, and diameter at breast height (DBH) were recorded if DBH was greater than 6.35cm. Year of mortality was estimated based on needle color and retention, if it wasn't directly observed between site visits. A small section of bark was removed from dead trees to confirm insect activity.  During the spring and early summer of 2018, all field plots were revisited to assess whether dead trees had fallen [@fettig2019].

### Instrumentation

Imagery was captured using a DJI Zenmuse X3 RGB camera [@dji2015] and a Micasense RedEdge3 5-band multispectral camera [@micasense2015]. We mounted both of these instruments simultaneously on a DJI Matrice 100 aircraft [@dji2015a] using the DJI 3-axis stabilized gimbal for the Zenmuse X3 camera and a Micasense angled fixed mount for the RedEdge3 camera. The gimbal and the angled fixed mount ensured both instruments were nadir-facing during image capture. Just prior to or after image capture at each site, we calibrated the RedEdge3 camera by taking an image of a calibration panel on the ground in full sun with known reflectance values for each of the 5 narrow bands (`r table_nums(name = "table-rededge-specs", display = "cite")`).

```{r}
table_nums(name = "table-rededge-specs", "Reflectance sensitivity of the Micasense Rededge3 camera. The calibration panel value represents the reflectance of the calibration panel for the given wavelength.")
```

```{r rededge_deets, echo = FALSE, include = TRUE, results = 'asis'}
rededge_print <- 
  tibble(`Band\nnumber` = 1:5,
         `Band\nname` = c("blue (b)", "green (g)", "red (r)", "near infrared (nir)", "red edge (re)"),
         `Center\nwavelength` = c(475, 560, 668, 840, 717),
         `Band\nwidth` = c(20, 20, 10, 40, 10),
         `Wavelength\nrange` = c("465-485", "550-570", "663-673", "820-860", "712-722"),
         `Panel\nreflectance` = c(0.64, 0.64, 0.64, 0.60, 0.63))

pandoc.table(rededge_print, 
             split.tables = Inf,
             caption = table_nums(name = "table-rededge-specs"),
             keep.line.breaks = TRUE)
```

### Flight protocol

Image capture was conducted as close to solar noon as possible to minimize shadow effects (varying primarily due to site accessibility; always within 4 hours, usually within 2 hours). Prior to the aerial survey, two strips of bright orange drop cloth (~100cm x 15cm) were positioned as an "X" over the permanent monuments marking the center of the 5 field plots from @fettig2019.

For each of the 36 sites (containing 5 plots each), we captured imagery over the surrounding ~40 hectares of forested area using north-south aerial transects. For three sites, we surveyed less surrounding area in order to maintain visual and radio communication with the aircraft during flight which can be obstructed by rolling terrain or non-centrally available takeoff locations.

We preprogrammed aerial transects using Map Pilot for DJI on iOS flight software (hereafter Map Pilot) [@dronesmadeeasy2018]. Using the Map Pilot software, we included an altitude adjustment along each aerial transect using a 1-arc-second digital elevation model [@farr2007] such that the aircraft's altitude remained approximately constant at 120 meters above ground level in order to maintain consistent ground sampling distance (centimeters on the ground per pixel) in the imagery. Ground sampling distance was approximately 5 cm/px for the Zenmuse X3 RGB camera and approximately 8 cm/px for the RedEdge3 multispectral camera. For this analysis, we dropped 4 sites whose imagery was of insufficient quality to process.

Structure from motion (SfM) processing requires highly overlapping images, especially in densely vegetated areas [@frey2018]. We planned transects with 90% forward overlap and 90% side overlap at 100 meters below the lens. Thus, with flights being at 120 meters above ground level, we achieved slightly higher than 90/90% overlap for objects under 20 meters tall (91.6/91.6% overlap at the ground). Overlap values were based on focal length (3.6mm), sensor width (6.2mm), and image dimension (4000x3000 pixels) parameters of the Zenmuse X3 camera. Images were captured at a constant rate of 1 image every 2 seconds for both cameras. A forward overlap of 90% at 100 meters translates to a flight speed of approximately 6.45 m/s and a side overlap of 90% at 100 meters translates to transects approximately 17.2 meters apart. The RedEdge3 camera has a different focal length (5.4mm), sensor width (4.8mm), and image dimension (1280x960 pixels), which translates to image overlap of 80.7/80.7 % at 100m below the lens and 83.9/83.9 % at ground level. Approximately 1900 photos were captured over each 40 hectare survey area for each camera.

### Structure from Motion (SfM) processing

We used structure from motion (SfM) to generate dense point clouds (`r fig_nums(name = "fig-dense-point-cloud", display = "cite")`), digital surface models (`r fig_nums(name = "fig-dsm", display = "cite")`), and orthorectified reflectance maps (`r fig_nums(name = "fig-ortho", display = "cite")`) for each field site [@frey2018]. We used Pix4Dmapper Cloud to process imagery using parameters ideal for images of a densely vegetated area taken by a multispectral camera. For 29 sites, we processed the RedEdge3 multispectral imagery alone. For three sites, we processed the RGB and the multispectral imagery in the same project to enhance the point density of the resulting point cloud. All SfM projects resulted in a single processing "block," indicating that all images in the project were optimized and processed together.


```{r}
fig_nums(name = "fig-dense-point-cloud", "A dense point cloud representing ~40 hectares of forest is generated using Structure from Motion (SfM) processing of ~1900 images. The dense point cloud z- position represents the ground elevation plus the vegetation height.")
```

![`r fig_nums(name = "fig-dense-point-cloud")`](../../figures/eldo_3k_3_point_cloud.png)

```{r}
fig_nums(name = "fig-dsm", "The digital surface model (DSM) is a 2-dimensional representation of the dense point cloud generated using structure from motion (SfM) processing. The DSM represents the ground elevation plus the vegetation height.")
```

![`r fig_nums(name = "fig-dsm")`](../../figures/eldo_3k_3_dsm.png)


```{r}
fig_nums(name = "fig-ortho", "The orthomosaic for each of the 32 sites is generated with the Structure from Motion (SfM) processing, showing a top-down view of the whole survey area such that distances between objects in the scene are preserved and can be measured. Depicted is an example orthomosaic for one of the 32 sites cropped to the extent of a single ground plot (5 ground plots per site) showing the orange X placed at exactly the plot center prior to flight. The original orthomosaic for the whole site represents an area approximately 1000 times as large as the area depicted here.")
```

![`r fig_nums(name = "fig-ortho")`](../../figures/eldo_3k_3_2_ortho-rgb.png)

### Creating canopy height models

```{r}
fig_nums(name = "fig-dtm", "The digital terrain model (DTM) is generated by processing the dense point cloud using the cloth simulation filter algorithm [@zhang2016], which classifies points as 'ground' or 'not-ground' and then interpolates the 'ground' elevation using Delaunay triangulation for the rest of the dense point cloud footprint. The DTM represents the ground elevation without any vegetation.")
```

![`r fig_nums(name = "fig-dtm")`](../../figures/eldo_3k_3_dtm.png)

```{r}
fig_nums(name = "fig-chm", "The canopy height model (CHM) is generated by subtracting the digital terrain model from the digital surface model. The CHM represents the height of all of the elevation above ground level.")
```

![`r fig_nums(name = "fig-chm")`](../../figures/eldo_3k_3_chm.png)

We classified each survey area's dense point cloud into "ground" and "non-ground" points using a cloth simulation filter algorithm [@zhang2016] implemented in the `lidR` [@roussel2019] package. We rasterized the ground points using the `raster` package [@hijmans2019] to create a digital terrain model (`r fig_nums(name = "fig-dtm", display = "cite")`) representing the ground underneath the vegetation at 1 meter resolution. We created a canopy height model (`r fig_nums(name = "fig-chm", display = "cite")`) by subtracting the digital terrain model from the digital surface model created in Pix4Dmapper.

### Tree detection

We tested a total of `r nrow(algorithm_summary)` automatic tree detection algorithms and a total of `r sum(algorithm_summary$n)` parameter sets on the canopy height model or the dense point cloud to locate trees within each site (`r table_nums(name = "table-algorithm-deets", display = "cite")`). We used `r algorithm_summary %>% dplyr::filter(algorithm == "vwf") %>% pull(n)` parameter sets of a variable window filter using the `vwf()` function in the `ForestTools` [@plowright2018] `R` package, including the default `winFun` parameter for the `vwf()` function as well as the "pines" and "combined" functions from @popescu2004 as the `winFun` parameter. We used `r algorithm_summary %>% dplyr::filter(algorithm == "localMaxima") %>% pull(n)` parameter sets of a local maximum filter implemented in `lidR`. We used `r algorithm_summary %>% dplyr::filter(algorithm == "li2012") %>% pull(n)` parameter sets of the algorithm from @li2012, which operates on the original point cloud. These parameter sets included those from @shin2018 and @jakubowski2013. We used `r algorithm_summary %>% dplyr::filter(algorithm == "watershed") %>% pull(n)` parameter sets of the `watershed` algorithm implemented in `lidR`, which is a wrapper for a function in the `EBImage` package [@pau2010]. We used `r algorithm_summary %>% dplyr::filter(algorithm == "ptrees") %>% pull(n)` parameter sets of `ptrees` [@vega2014] implemented in `lidR` [@roussel2019] and `lidRplugins` [@roussel2019a] and which operates on the raw point cloud, without first normalizing it to height above ground level (i.e.. subtracting the ground elevation from the dense point cloud). We used the default parameter set of the `multichm` [@eysn2015] algorithm implemented in `lidR` [@roussel2019] and `lidRplugins` [@roussel2019a]. Finally, we used `r algorithm_summary %>% dplyr::filter(algorithm == "lmfx") %>% pull(n)` parameter sets of the experimental algorithm `lmfx` [@roussel2019a].

```{r}
table_nums(name = "table-algorithm-deets", "Algorithm name, number of parameter sets tested for each algorithm, and references.")
```

```{r algorithm_summary_print, echo = FALSE, include = TRUE, results = 'asis'}
algorithm_summary_print <-
  algorithm_summary %>% 
  dplyr::rename(`Parameter sets\ntested` = n,
                Algorithm = algorithm) %>%
  dplyr::mutate(`Reference(s)` = c("@li2012; @jakubowski2013; @shin2018", "@roussel2019a", "@roussel2019", "@eysn2015", "@vega2014", "@plowright2018", "@pau2010"))

pandoc.table(algorithm_summary_print, 
             split.tables = Inf,
             caption = table_nums(name = "table-algorithm-deets"),
             keep.line.breaks = TRUE)
```

### Map ground data

Each orthorectified reflectance map was inspected to locate the 5 orange "X"s marking the center of the field plots (`r fig_nums(name = "fig-ortho", display = "cite")`), though some plot centers were obscured due to dense interlocking tree crowns or because a plot center was located directly under a single tree crown. We were able to locate 110 out of 180 field plots and were then able to use these plots for validation of automated tree detection algorithms. We used the `sf` package [@pebesma2019] to convert distance-from-center and azimuth measurements of each tree in the ground plots to an x-y position on the SfM-derived reflectance map using the x-y position of the orange X visible in the reflectance map as the center.

### Correspondence of automatic tree detection with ground data

We calculated 7 forest structure metrics for each field plot using the ground data collected by @fettig2019: total number of trees, number of trees greater than 15 meters, mean height of trees, 25^th^ percentile tree height, 75^th^ percentile tree height, mean distance to nearest tree neighbor, mean distance to 2^nd^ nearest neighbor.

For each tree detection algorithm and parameter set described above, we calculated the same set of 7 structure metrics within the footprint of the validation field plots. We calculated the Pearson's correlation and root mean square error (RMSE) between the ground data and the aerial data for each of the 7 structure metrics for each of the `r sum(algorithm_summary$n)` automatic tree detection algorithms/parameter sets.

For each algorithm and parameter set, we calculated its performance relative to other algorithms as whether its Pearson's correlation was within 5% of the highest Pearson's correlation as well as whether its RMSE was within 5% of the lowest RMSE. For each algorithm/parameter set, we summed the number of forest structure metrics for which it reached these 5% thresholds. For automatically detecting trees across the whole study, we selected the algorithm/parameter set that performed well across the most number of forest metrics (`r fig_nums(name = "fig-tree-locations", display = "cite")`).

```{r}
fig_nums(name = "fig-tree-locations", "Tree locations are detected using the `lmfx` [@roussel2019] treetop detection algorithm on the dense point cloud.")
```

![`r fig_nums(name = "fig-tree-locations")`](../../figures/eldo_3k_3_ttops.png)


### Segmentation of crowns

```{r}
fig_nums(name = "fig-crown-segmentation", "Individual crowns are delineated using a marker controlled watershed segmentation algorithm [@meyer1990; @plowright2018] on the canopy height model (CHM) using the detected tree locations as a priority map. If the algorithm failed to delineate a crown for a tree that was identified in the tree detection step, a circular crown with a 0.5m buffer centered on point location of the detected tree was added as a crown.")
```

![`r fig_nums(name = "fig-crown-segmentation")`](../../figures/eldo_3k_3_crowns.png)

We delineated individual tree crowns with a marker controlled watershed segmentation algorithm [@meyer1990] using the detected treetops as markers implemented in the `ForestTools` package [@plowright2018]. If the automatic segmentation algorithm failed to generate a crown segment for a detected tree (e.g., often snags with a very small crown footprint), a circular crown was generated with a radius of 0.5 meters. If the segmentation generated multiple polygons for a single detected tree, only the polygon containing the detected tree was retained (`r fig_nums(name = "fig-crown-segmentation", display = "cite")`). Image overlap decreases near the edges of the overall flight path, which reduces the quality of the SfM processing in those areas. Thus, we excluded segmented crowns within 35 meters of the edge of the survey area. Given the narrower field of view of the RedEdge3 multispectral camera versus the X3 RGB camera whose optical parameters were used to define the ~40 hectare survey area around each site, as well as the 35 meter additional buffering, the survey area at each site was approximately 30 hectares (`r table_nums(name = "table-site-deets", display = "cite")`).

We used the `velox` package [@hunziker2017] to extract all the pixel values from the orthorectified reflectance map for each of the 5 narrow bands within each segmented crown polygon. Per pixel, we additionally calculated the normalized difference vegetation index (NDVI; @rouse1973), the normalized difference red edge (NDRE; @gitelson1994), the red-green index (RGI; @coops2006), the red edge chlorophyll index (CI~red~ ~edge~; @clevers2013), and the green chlorophyll index (CI~green~; @clevers2013). For each crown polygon, we calculated the mean value for each raw and derived reflectance band (5 raw; 5 derived).

### Classification of trees

```{r}
fig_nums(name = "fig-live-dead-classification", "Each tree is classified as live or dead by extracting the pixel values from the 5 narrow bands of the Rededge3 camera (and 5 derived bands-- see methods) in the orthomosaic within each segmented tree crown of the detected trees, taking their mean value, and using those means to predict live/dead status with a boosted logistic regression previously trained on a hand-classified set of segmented crowns from across the study area.")
```

![`r fig_nums(name = "fig-live-dead-classification")`](../../figures/eldo_3k_3_live_dead.png)

```{r}
fig_nums(name = "fig-host-non-host", "For each live tree, we classified its species using the same means of extracted pixel values across the 5 Rededge3 narrow bands (and 5 derived bands) as predictors in a regularized discriminant analysis previously trained on a hand-classified set of segmented crowns from across the study area.")
```

![`r fig_nums(name = "fig-host-non-host")`](../../figures/eldo_3k_3_host_nonhost.png)

We overlaid the segmented crowns on the reflectance maps from `r length(unique(hand_classified_crowns$site))` sites spanning the latitudinal and elevation gradient in the study. Using QGIS, we hand classified `r nrow(hand_classified_crowns)` trees as live/dead (`r fig_nums(name = "fig-live-dead-classification", display = "cite")`) and as one of 5 dominant species in the study area (*Pinus ponderosa*, *Pinus lambertiana*, *Abies concolor*, *Calocedrus decurrens*, or *Quercus kelloggi*) using the mapped ground data as a guide. We treated all trees classified as ponderosa pine as a "host" tree and all other species as "non-host" trees (`r fig_nums(name = "fig-host-non-host", display = "cite")`). 

We used all 10 mean values of the reflectance bands for each tree crown polygon to predict whether the hand classified trees were alive or dead using a boosted logistic regression model implemented in the `caret` package (accuracy of live/dead classification on a withheld test dataset: `r round(classifier_stats[classifier_stats$type == "live/dead", "accuracy"] %>% pull() * 100, 1)`%) [@kuhn2008]. For just the living trees, we similarly used all 10 reflectance values to predict the tree species using regularized discriminant analysis implemented in the `caret` package (accuracy of species classification on a withheld testing dataset: `r round(classifier_stats[classifier_stats$type == "species", "accuracy"] %>% pull() * 100, 1)`%; accuracy of WPB host/non-WPB-host (i.e., ponderosa pine versus other tree species) on a withheld testing dataset: `r round(classifier_stats[classifier_stats$type == "host/non-host", "accuracy"] %>% pull() * 100, 1)`%).

Finally, we used these models to classify all tree crowns in the data set as alive or dead as well as the species of living trees.

### Allometric scaling of height to quadratic mean diameter

We converted the height of each tree determined using the canopy height model to its diameter at breast height, 1.37m (DBH). Using the tree height and DBH ground data from @fettig2019, we fit a simple linear regression to predict DBH from height for each of the 5 dominant species. Using the model-classified tree species of each segmented tree, we used the corresponding linear relationship for that species to estimate the DBH given the tree's height. We then calculated the quadratic mean diameter for each 20m x 20m cell as the square root of the average squared diameter of trees within the cell.

### Note on assumptions about dead trees

For the purposes of this study, we assumed that all dead trees were ponderosa pine and were thus host trees for the western pine beetle. This is a reasonably good assumption for our study area, given that @fettig2019 found that `r pipo_pct_of_all_dead`% of the dead trees in the coincident ground plots were ponderosa pine. The species contributing to the next highest proportion of dead trees was incense cedar which represented `r cade_pct_of_all_dead`% of the dead trees in the ground plots. Incense cedar is not a potential host of the western pine beetle, and different forest structure/environment conditions can dictate the dynamic between forest insects and their host tree species [@stephenson2019]. While the detected mortality is most likely to be ponderosa pine, it is critical to interpret our results with this known limitation in mind.

### Rasterizing individual tree data

```{r}
fig_nums(name = "fig-rasterized-prop-dead", "We rasterized the individual tree data by aggregating values to 20m x 20m cells. This example shows the proportion of dead trees per cell for the same example site as in the previous figures.")
```

![`r fig_nums(name = "fig-rasterized-prop-dead")`](../../figures/proportion-dead-rasterized.png)

Because the tree detection algorithms were validated against ground data at the plot level, we rasterized the classified trees at a spatial resolution similar to that of the ground plots (`r fig_nums(name = "fig-rasterized-prop-dead", display = "cite")`). That is, we rasterized the individual tree data to 20m x 20m pixels equaling 400 m^2^, and the circular ground plots with 11.35m radius covered 404 m^2^. In each raster cell, we calculated the: number of live trees, number of dead trees, number of ponderosa pine trees, total number of trees (of all species, including ponderosa pine), quadratic mean diameter (QMD) of ponderosa pine trees, and QMD of all trees of any species (overall QMD). We converted the count of ponderosa pine trees and the total tree count to a density measurement of trees per hectare (tpha) by multiplying the counts in each 20m x 20m cell by `r 10000/400` to create a "host density" and an "overall density" variable per cell.

### Environmental data

We used climatic water deficit (CWD) [@stephenson1998] from the 1981-2010 mean value of the basin characterization model [@flint2013] as an integrated measure of temperature and moisture conditions for each of the 32 sites. Higher values of CWD correspond to hotter, drier conditions and lower values correspond to cooler, wetter conditions. CWD has been shown to correlate well with broad patterns of tree mortality in the Sierra Nevada [@young2017] as well as bark beetle-induced tree mortality [@millar2012]. We converted the CWD value for each site into a z-score representing that site's deviation from the mean CWD across the climatic range of Sierra Nevada ponderosa pine as determined from 179 herbarium records described in @baldwin2017a. Thus, a CWD z-score of one would indicate that the CWD at that site is one standard deviation hotter/drier than the mean CWD across all geolocated herbarium records for ponderosa pine in the Sierra Nevada.

### Statistical model

We used a generalized linear model with a zero-inflated binomial response and a logit link to predict the probability of ponderosa pine mortality within each 20m x 20m cell as a function of the crossed effects of ponderosa pine quadratic mean diameter and density added to the crossed effect of quadratic mean diameter and density of trees of all species in each cell (hereafter "overall quadratic mean diameter" and "overall density"), as well as the interaction of each summand with climatic water deficit at each site. 

To measure and account for spatial autocorrelation of the bark beetle behavioral processes underlying ponderosa pine mortality, we subsampled the data at each site to a random selection of 200, 20m x 20m cells representing approximately 27.5% of the surveyed area. With these subsampled data, we included a separate exact Gaussian process term per site of the interaction between the x- and y-position of each cell using the `gp()` function in the `brms` package [@burkner2017]. The Gaussian process estimates the spatial covariance in the response variable (log-odds of ponderosa pine mortality) jointly with the effects of the other covariates.

$$
\begin{aligned}
y_{i,j} \sim &\ \begin{cases}
0, & p \\
Binom(n_i, \pi_i), & 1-p
\end{cases} \\
logit(\pi_i) = &\ \beta_0\ + \\
& \beta_1X_{cwd, j}\ + \\
& \beta_1X_{cwd, j}(\beta_2X_{pipoQMD, i} + \beta_3X_{pipoDensity, i} + \beta_4X_{pipoQMD, i}X_{pipoDensity, i})\ + \\ 
& \beta_1X_{cwd, j}(\beta_5X_{overallQMD, i} + \beta_6X_{overallDensity, i} + \beta_7X_{overallQMD, i}X_{overallDensity, i})\ + \\
& \mathcal{GP}_j(x_i, y_i) \\
\end{aligned}
$$

Where $y_i$ is the number of dead trees in cell $i$, $n_i$ is the sum of the dead trees (assumed to be ponderosa pine) and live ponderosa pine trees in cell $i$, $\pi_i$ is the probability of ponderosa pine tree mortality in cell $i$, $p$ is the probability of there being zero dead trees in a cell arising as a result of an unmodeled process, $X_{cwd, j}$ is the z-score of climatic water deficit for site $j$, $X_{pipoQMD, i}$ is the scaled quadratic mean diameter of ponderosa pine in cell $i$, $X_{pipoDensity, i}$ is the scaled density of ponderosa pine trees in cell $i$, $X_{overallQMD, i}$ is the scaled quadratic mean diameter of all trees in cell $i$, $X_{overallDensity, i}$ is the scaled density of all trees in cell $i$, $x_i$ and $y_i$ are the x- and y- coordinates of the centroid of the cell in an EPSG3310 coordinate reference system, and $\mathcal{GP}_j$ represents the exact Gaussian process describing the spatial covariance between cells at site $j$.

We used 4 chains with 2000 iterations each (1000 warmup, 1000 samples), and confirmed chain convergence by ensuring all `Rhat` values were less than 1.1 [@brooks1998]. We used posterior predictive checks to visually confirm model performance by overlaying the density curves of the predicted number of dead trees per cell over the observed number [@gabry2019]. For the posterior predictive checks, we used 50 random samples from the model fit to generate 50 density curves and ensured curves were centered on the observed distribution, paying special attention to model performance at capturing counts of zero.

### Software and data availability

All data are available via the Open Science Framework. Statistical analyses were performed using the `brms` packages. With the exception of the SfM software (Pix4Dmapper Cloud) and the GIS software QGIS, all data carpentry and analyses were performed using `R` [@rcoreteam2018].

## Results

```{r site_characteristics_read_file}
site_characteristics <- read_csv(here::here("analyses/analyses_output/summarized-non-spatial-site-data.csv"))
```

```{r}
table_nums(name = "table-site-deets", "Site characteristics for each of the 32 sites. The site name consists of the forest name, elevation band, and rep separated by an underscore. The Eldorado National Forest is 'eldo', the Stanislaus National Forest is 'stan', the Sierra National Forest is 'sier', and the Sequoia National Forest is 'sequ'. The elevation band represents the lower bounds of the 305 meter (1000 foot) elevation bands in feet. Thus '3k' implies that site was located between 3,000 and 4,000 feet (914-1219 meters). Aerially detected mortality and density of the whole site is presented along with the mortality and density calculated from the ground data (aerial / ground). The density is measured in trees per hectare (tpha).")
```

```{r site_characteristics, echo = FALSE, include = TRUE, results = 'asis'}
site_characteristics <- 
   site_characteristics %>% 
  tidyr::separate(site, into = c("Forest", "Elevation band", "Rep"), remove = FALSE) %>% 
  dplyr::mutate(`Mortality\n(aerial/ground)` = paste(sprintf("%0.2f", prop_mortality), sprintf("%0.2f", ground_mortality), sep = "/"),
                `Density\n(tpha; aerial/ground)` = paste(sprintf("%0.2f", air_tpha), sprintf("%0.2f", ground_tpha), sep = "/")) %>% 
  dplyr::rename(`CWD\n(mm)` = site_cwd,
                `CWD\n(z-score)` = site_cwd_zscore,
                `Survey area\n(ha)` = buffered_survey_area,
                Site = site) %>% 
  dplyr::mutate(Forest = case_when(Forest == "eldo" ~ "Eldorado",
                                   Forest == "stan" ~ "Stanislaus",
                                   Forest == "sier" ~ "Sierra",
                                   Forest == "sequ" ~ "Sequoia")) %>% 
  dplyr::mutate(Forest = factor(Forest, levels = c("Eldorado", "Stanislaus", "Sierra", "Sequoia"))) %>% dplyr::arrange(Forest, `Elevation band`, Rep) %>% 
  dplyr::select(Site, `CWD\n(mm)`, `CWD\n(z-score)`, `Survey area\n(ha)`, `Mortality\n(aerial/ground)`, `Density\n(tpha; aerial/ground)`)

pandoc.table(site_characteristics, 
             digits = c(10, 3, 3, 4, 10, 10), 
             split.tables = Inf,
             caption = table_nums(name = "table-site-deets"),
             keep.line.breaks = TRUE)
```

### Tree detection

We found that the experimental `lmfx` algorithm with parameter values of `dist2d = `r algorithm_details[1, "var1_val"]`` and `ws = `r algorithm_details[1, "var2_val"]`` [@roussel2019] performed the best across 7 measures of forest structure as measured by Pearson's correlation with ground data (`r table_nums(name = "table-best-algorithm-deets", display = "cite")`).

```{r}
table_nums(name = "table-best-algorithm-deets", paste0("Correlation and differences between the best performing tree detection algorithm (lmfx with dist2d = ", algorithm_details[1, "var1_val"], " and ws = ", algorithm_details[1, "var2_val"], ") and the ground data. An asterisk next to the correlation or RMSE indicates that this value was within 5% of the value of the best-performing algorithm/parameter set. Ground mean represents the mean value of the forest metric across the 110 ground plots that were visible from the sUAS-derived imagery. The median error is calculated as the median of the differences between the air and ground values for the 110 visible plots. Thus, a positive number indicates an overestimate by the sUAS workflow and a negative number indicates an underestimate."))
```

```{r best_algorithm_deets_table, echo = FALSE, include = TRUE, results = 'asis'}
best_algorithm_deets_print <-
  best_algorithm_deets %>% 
  ungroup() %>% 
  dplyr::select(forest_metric, ground_correlation, rmse, me, med_error, ground_cor_within_threshold_pct, rmse_within_threshold_pct) %>% 
  dplyr::mutate(ground_correlation = ifelse(ground_cor_within_threshold_pct == 1, yes = paste0(as.character(sprintf("%0.2f", ground_correlation)), "*"), no = as.character(sprintf("%0.2f", ground_correlation)))) %>% 
  dplyr::mutate(rmse = ifelse(rmse_within_threshold_pct == 1, yes = paste0(as.character(sprintf("%0.2f", rmse)), "*"), no = as.character(sprintf("%0.2f", rmse)))) %>% 
  dplyr::select(forest_metric, ground_correlation, rmse, me, med_error) %>% 
  dplyr::mutate(forest_metric = c("height (m); 25th percentile",
                                  "height (m); mean",
                                  "height (m); 75th percentile",
                                  "distance to 1st neighbor (m)",
                                  "distance to 2nd neighbor (m)",
                                  "distance to 3rd neighbor (m)",
                                  "total tree count",
                                  "count of trees > 15m",
                                  "count of trees < 15m")) %>% 
  dplyr::rename(`Forest structure metric` = forest_metric,
                `Correlation with ground` = ground_correlation,
                RMSE = rmse,
                `Mean error` = me,
                `Median error` = med_error) %>% 
  dplyr::mutate(sort = c(7:9, 4:6, 1:3)) %>% 
  dplyr::arrange(sort) %>% 
  dplyr::mutate(`Ground mean` = t(ground_tree_summary_print)[, 1]) %>% 
  dplyr::select(`Forest structure metric`,
                `Ground mean`,
                `Correlation with ground`,
                RMSE,
                `Median error`) %>% 
  dplyr::filter(`Forest structure metric` %in% 
                  c("height (m); 25th percentile",
                    "height (m); mean",
                    "height (m); 75th percentile",
                    "distance to 1st neighbor (m)",
                    "distance to 2nd neighbor (m)",
                     "total tree count",
                    "count of trees > 15m"))

pandoc.table(best_algorithm_deets_print, 
             digits = 2, 
             split.tables = Inf,
             caption = table_nums(name = "table-best-algorithm-deets"),
             keep.line.breaks = TRUE)
```

### Effect of local structure and regional climate on western pine beetle severity

```{r}
fig_nums(name = "fig-halfeye", "Posterior distributions of effect size from zero-inflated binomial model predicting the probability of ponderosa pine mortality in a 20m x 20m cell given forest structure characteristics of host trees and all trees within the cell, as well as a site-level climatic water deficit. The gray density distribution for each model covariate represents the density of the posterior distribution, the point underneath each density curve represents the median of the estimate, the bold interval surrounding the point estimate represents the 66% credible interval, and the thin interval surrounding the point estimate represents the 95% credible interval.")
```

![`r fig_nums(name = "fig-halfeye")`](../../figures/effect-sizes-halfeye.png)

We detected a small, generally positive main effect of climatic water deficit on the probability of ponderosa pine mortality within each 20m x 20m cell (`r fig_nums(name = "fig-halfeye", display = "cite")`). 

We found a strongly positive main effect of ponderosa pine local density, with greater density increasing the probability of ponderosa pine mortality. Conversely, we found a strong negative effect of overall tree density (i.e., including both ponderosa pine and non-host species) such that additional non-host trees in a 20m x 20m cell (for the same number of host trees) would decrease the probability of ponderosa pine mortality (`r fig_nums(name = "fig-halfeye", display = "cite")`).

We found a generally negative effect of quadratic mean diameter of ponderosa pine on the probability of ponderosa mortality, suggesting that the western pine beetle attacked smaller trees, on average. There was a strong positive interaction between the climatic water deficit and ponderosa pine quadratic mean diameter, such that larger trees were more likely to increase the probability of ponderosa mortality in hotter, drier sites (`r fig_nums(name = "fig-three-way-interaction", display = "cite")`).

There was a positive interaction between overall tree density and overall quadratic mean diameter, such that denser stands with larger trees did lead to greater ponderosa pine mortality, though the main effects of each of these variables were weakly negative (`r fig_nums(name = "fig-halfeye", display = "cite")`). 

```{r}
fig_nums(name = "fig-three-way-interaction", "Line version of model results with 95% credible intervals showing primary influence of ponderosa pine structure on the probability of ponderosa pine mortality, and the interaction across climatic water deficit. The 'larger trees' line represents the quadratic mean diameter of ponderosa pine 0.7 standard deviations above the mean, and the 'smaller trees' line represents the quadratic mean diameter of ponderosa pine 0.7 standard deviations below the mean.")
```

![`r fig_nums(name = "fig-three-way-interaction")`](../../figures/pipo_tpha_qmd_cwd_interaction.png)

## Discussion

We used a small, unhumanned aerial system to measure components of complex forest structure across a broad environmental gradient of climatic water deficit in yellow pine/mixed-conifer forests of the Sierra Nevada, California heavily disturbed by the western pine beetle. By collecting individual tree-level data for ~30 hectares at each of 32 sites along the environmental gradient, we were able to simultaneously consider how local-scale forest structure (tree size, tree host/non-host composition, and tree density) interacted with broad-scale climate conditions to drive the probability of host tree (ponderosa pine) mortality, while also accounting for spatial aggregation of mortality arising from bark beetle host selection behavior.

## Broad-scale environmental condition

We were surprised to only find a weakly positive main effect of climatic water deficit on the probability of ponderosa mortality, though an effect did materialize through its interaction with forest structure. We did not measure tree water stress at an individual tree level as in other recent work [@stephenson2019], and were instead treating climatic water deficit as a general indicator of tree stress following results of coarser-scale studies [@asner2016; @young2017] which may have contributed to our failure to detect a strong effect. Also, our entire study area experienced the same extreme hot drought between 2012 and 2015 and the variation of mortality explained by a main effect of climatic water deficit may be dampened when most trees are experiencing a high degree of water stress [@floyd2009; @fettig2019].

## Strength of support for different "density increases mortality" hypotheses

We modeled the effect of overall (i.e., all tree species included) tree size and density as well as host (i.e. ponderosa pine) tree size and density on the probability of host tree mortality in order to gain insights about the relative influence of different facets of complex forest structure.

The strongest effect on the probability of host mortality was the local host density within each 20m x 20m cell. Host availability has been shown to have a strong influence on the prevalence of host mortality [@raffa1987]. This can arise as beetles require shorter flights to disperse to new hosts and beetles are less likely to land on a non-host tree which imposes a "sunk cost" of energy expenditure in getting to that tree. Reduced dispersal distances to host trees likely favors successful bark beetle attacks, but we calibrated our aerial tree detection to ~400 m^2^ areas rather than to individual tree locations so don't have the data precision to address this hypothesis directly. Because we also found a strong negative effect of overall tree density (host plus non-host) within each cell while accounting for host density, we suspect that the positive association between host density and host mortality might be driven by increasing the frequency that western pine beetles land on their preferred host and avoid expending energy flying to non-hosts. The negative relationship that we detected between overall tree density and host mortality corroborates findings from @fettig2019 and perhaps the "sunk cost" of landing on non-hosts explains those findings, though @fettig2019 didn't simultaneously model the effect of host density. In general, @hayes2009 and @fettig2019 found that measures of host availability explained less variation in mortality than measures of overall tree density, but those conclusions were based on a response variable of "total number of dead host trees," rather than the number of dead host trees conditional on the total number of host trees as in our study (i.e., a binomial response).

Counter to our expectations, we found an overall negative effect of host tree mean size on the probability of host mortality. Generally, smaller trees are easier for western pine beetles to overwhelm in a mass attack and are prime targets under normal levels of tree water stress. However, larger trees are more nutritious and are therefore ideal targets if local bark beetle density is high enough to successfully initiate mass attack as can occur when many trees are under severe water stress [@bentz2010]. In the recent hot drought, we expected that most trees would be under severe water stress, setting the stage for increasing beetle density, successful mass attacks, and targeting of larger trees. Larger average tree size in this case would therefore lead to greater ponderosa pine mortality, as was found in coincident ground plots [@fettig2019] and other studies [@pile2019; @stephenson2019]. One possible explanation for our finding is that our observations represent the cumulative mortality of trees during a multi-year drought event and its aftermath. Lower host tree mean size led to a greater probability of host mortality earlier in the drought [@pile2019] and that signal might have persisted even as mortality continued to accumulate driven by other factors. 

We did find a clear host tree size effect in its interaction with the climatic water deficit. In hot, dry sites, larger average host size increased the probability of host mortality while smaller host sizes increased the probability of host mortality in cool, wet sites. This suggests that the same bark beetle species was cueing into different aspects of forest structure across the environmental gradient. This represents an intraspecific version of the results of @stephenson2019, who found that insect-induced tree mortality in the same region during the same hot drought were driven by different factors for different tree species. For instance, @stephenson2019 found that ponderosa pine mortality was largely driven by host selection behavior of forest insects, where larger more nutritious trees were specifically targeted regardless of whether they exhibited signs of stress. In contrast, @stephenson2019 found that white fir mortality occurred predominantly in the slower growing, smaller, stressed trees. In our study, we found that, even within a single pairing of forest insect species and its host, the host tree size affected host mortality differently depending on the site-level climatic water deficit. 

For aggressive bark beetles, massive tree mortality as observed from the 2012-2015 drought and its aftermath does not necessarily distinguish "endemic" from "outbreak" phases of bark beetle disturbance, which is instead distinguished by the underlying driver of bark beetle host selection behavior [@logan1998]. "Endemic" phases are distinguished by environmental determinism, when beetles select hosts based on whether they are weakened in some way, often by environmental conditions. "Outbreak" phases are distinguished by dynamic determinism, when population dynamics reign-- when local beetle density is high enough that intraspecific pheromone communication dominates host selection, successful mass attacks are likely, and even large healthy trees can be killed [@white1997; @logan1998]. Despite high local levels of tree mortality across our study area [@fettig2019], our results from surveying the broader context surrounding coincident ground plots reveals different effects of host tree size depending on the climatic water deficit, and perhaps different stages of bark beetle disturbance across the environmental gradient. This may help explain the especially high host mortality in high host density, low host size cells that we observed in cool/wet sites (`r fig_nums(name = "fig-three-way-interaction", display = "cite")`). The smaller trees would presumably be nutritionally sub-optimal, and thus unexpected targets if the western pine beetle were indeed in an "outbreak" phase at these sites and able to attack even large, healthy trees. While trees were likely water stressed across the whole study due to the extreme drought, we expected generally less water stress in the cool/wet sites, and generally higher water stress in the hot/dry sites [@asner2016; @young2017]. Thus, it is possible that the observed mortality patterns across the Sierra Nevada during the 2012-2015 hot drought arose as synergistic alignment of environmental conditions and complex forest structure enabled the western pine beetle to cross thresholds of "outbreak" behavior in the hottest, driest sites but such an alignment was not present in the cooler, wetter sites [@raffa2008].

## Limitations and future directions

We have demonstrated that small, unhummaned aerial systems (sUAS) can be effective means of collecting data at multiple, vastly different spatial scales to investigate a single, multi-scale phenomenon-- from meters in between trees, to hundreds of meters of elevation, to hundreds of thousands of meters of latitude. However, some limitations remain but could perhaps be overcome with further refinements in the use of this tool for forest ecology. Most of these limitations arise from tree detection and classification uncertainty, and thus it was imperative to work with field data for calibration and uncertainty reporting.

The greatest limitation in our study arising from classification uncertainty is in the assumption that all dead trees were ponderosa pine. We estimate from coincident ground plots that this is true approximately `r pipo_pct_of_all_dead`% of the time. Because tree mortality response to forest insects is species-specific, even with sympatric tree species during the same hot drought [@stephenson2019], we cannot entirely rule out that some of the mortality responses to complex forest structure that we observed arose from these species-specific responses. The overall community composition across our study area was not very different [@fettig2019], so we remain confident that the patterns we observed were driven primarily by the dynamic between the western pine beetle and ponderosa pine.

Our ability to detect trees using the geometry of the dense point clouds derived with the SfM was also limited. The horizontal accuracy of the tree detection was better than the vertical accuracy, which may result from a more significant error contribution by the ground-based calculations of tree height compared to tree position relative to plot center (`r table_nums(name = "table-best-algorithm-deets", display = "cite")`). Both the horizontal and vertical accuracy would likely improve with better SfM point clouds, which requires imagery with more overlap. @frey2018 recently found that 95% overlap was preferable for generating dense point clouds, and we only achieved 91.6% overlap with the X3 RGB camera and 83.9% overlap with the multispectral camera. While our live/dead classification was fairly accurate (`r round(classifier_stats[classifier_stats$type == "live/dead", "accuracy"] %>% pull() * 100, 1)`% on a withheld dataset), our species classifier would likely benefit from better crown segmentation because the pixel-level reflectance values within each crown are averaged to characterize the "spectral signature" of each tree. With better delineation of each tree crown, the mean value of pixels within each tree crown will likely be more representative of that tree's spectral signature. Better crown segmentation would most readily be achieved through greater overlap in imagery. Finally, we anticipate that computer vision and deep learning will prove helpful in overcoming some of these detection and classification challenges [@gray2019].

## Conclusions

Climate change adaptation strategies emphasize reducing tree densities to restore forest resilience [@north2015; @young2017], but understanding the optimal complex forest structure that can enable dry western U.S. forests to persist through disturbances such as insect attack will be vital for predicting how California forests may respond to these interventions. We've shown that small, unhumanned aerial systems can be a valuable tool for investigating how this complexity in forest structure combines with environmental conditions to shape forest insect disturbance. We found that host tree density is a dominant driver of host mortality, likely due to energy costs associated with beetles navigating forests with many non-hosts available. We also showed that, even within a single forest insect/tree species pairing, in the same extreme drought, and conditional upon high levels of western pine beetle activity, host tree size may still strongly affect insect-induced tree mortality in different ways depending on background environmental conditions of water stress. We suggest that this may indicate different stages of bark beetle disturbance throughout the Sierra yellow pine/mixed-conifer system, with "outbreak" thresholds surpassed at the hottest, driest sites where larger trees led to more likely host mortality, but not yet surpassed in cooler, wetter sites, where smaller trees led to more likely host mortality.

Thus, we echo the conclusions of other researchers in that management interventions to reduce the severity of bark beetle disturbance severity will benefit from generally reducing tree density in this system [@young2017], but also that outcomes will be largely dependent on whether the disturbance dynamic has crossed various feedback thresholds [@raffa2008], which may be ascertained by recent advances in disturbance forecasting [@preisler2017].

## Acknowledgements

We gratefully acknowledge funding from the U.S.D.A. Forest Service Western Wildlands Environmental Threat Assessment Center (WWETAC) as well as Connie Millar for comments and guidance during the development of this project.

## References